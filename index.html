<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stockify å°ˆæ¥­ç‰ˆ v4.3.8</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* ğŸ”¥ å…¨é¢é©é… iOSï¼šé–æ­»è¦–å£èˆ‡æ»¾å‹• ğŸ”¥ */
        html, body {
            position: fixed;
            top: 0; bottom: 0; left: 0; right: 0;
            width: 100%; height: 100%;
            margin: 0; padding: 0;
            overflow: hidden; 
            background-color: #f3f4f6;
            font-family: 'Inter', "Microsoft JhengHei", sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none; /* ç¦ç”¨å½ˆå›å‹•ç•« */
        }
        
        #root { width: 100%; height: 100%; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent; bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }

        .nav-island { bottom: calc(16px + env(safe-area-inset-bottom, 0px)); }
        .fab-btn { bottom: calc(24px + env(safe-area-inset-bottom, 0px)); }
        .content-pb { padding-bottom: calc(140px + env(safe-area-inset-bottom, 0px)); }

        @media (min-width: 640px) {
            .nav-island { bottom: 32px; }
            .fab-btn { bottom: 40px; }
        }
        
        /* é¿å…å¯¬åº¦è¶…å‡ºç”¢ç”Ÿå·¦å³æ»‘å‹• */
        * { box-sizing: border-box; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase è¨­å®š ---
        const localFbConfigStr = localStorage.getItem('stockify_firebase_config');
        let parsedLocalFbConfig = null;
        try { if (localFbConfigStr) parsedLocalFbConfig = JSON.parse(localFbConfigStr); } catch(e) {}

        const firebaseConfig = parsedLocalFbConfig || (window.__firebase_config ? JSON.parse(window.__firebase_config) : {
            apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: ""
        });

        const isFirebaseConfigured = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey.trim() !== "";
        let auth = null, db = null;
        if (isFirebaseConfigured) {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        }

        const APP_VERSION = 'v4.3.8';
        const APP_ID = 'stockify-v4';
        const TOKEN_KEY = 'stockify_token';
        const MY_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNi0wMy0wMSAwMjowOTo0OCIsInVzZXJfaWQiOiJob25nYm95IiwiZW1haWwiOiJob25nYm95OTJAZ21haWwuY29tIiwiaXAiOiI2MS4yMjAuOTMuNzQifQ.Mk4GPZsGRLM79QvxVHIcRXE5y_FThk9uMCsoJfmQCYc";
        const STORAGE_KEY = 'stockify_v4_txs';
        const MASTER_KEY = 'stockify_v4_master';

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                PieChart: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z"/>,
                History: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-4v4h4"/>,
                Plus: <path d="M12 5v14M5 12h14"/>,
                Coins: <React.Fragment><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18.1"/></React.Fragment>,
                Refresh: <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>,
                Settings: <React.Fragment><path d="M12.22 2h-.44a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2a2 2 0 0 1 2 2a2 2 0 0 0 2 2a2 2 0 0 1 2 2a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0 2-2v-.44a2 2 0 0 0-2-2a2 2 0 0 1-2-2a2 2 0 0 0-2-2a2 2 0 0 1-2-2a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></React.Fragment>,
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                ArrowUpDown: <path d="m21 16-4 4-4-4M21 20V12M3 8l4-4 4 4M3 4v8"/>,
                ToggleLeft: <React.Fragment><rect width="20" height="12" x="2" y="6" rx="6"/><circle cx="8" cy="12" r="2"/></React.Fragment>,
                ToggleRight: <React.Fragment><rect width="20" height="12" x="2" y="6" rx="6" fill="#3B82F6"/><circle cx="16" cy="12" r="2" fill="white"/></React.Fragment>,
                Trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>,
                Calendar: <React.Fragment><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></React.Fragment>,
                Key: <React.Fragment><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3v-3.5L15.5 7.5z"/></React.Fragment>,
                Download: <React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5m-5 5V3"/></React.Fragment>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-4v4h4"/>,
                AlertCircle: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></React.Fragment>,
                Loader2: <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>,
                CheckCircle2: <React.Fragment><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></React.Fragment>,
                Upload: <React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5-5-5-5 5m5-5v12"/></React.Fragment>,
                Cloud: <React.Fragment><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></React.Fragment>
            };
            return (
                <svg width={className ? "100%" : size} height={className ? "100%" : size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" stroke="red" />}
                </svg>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [isCloudLoading, setIsCloudLoading] = useState(true);
            const [view, setView] = useState('holding'); 
            const [transactions, setTransactions] = useState([]);
            const [stockMaster, setStockMaster] = useState({}); 
            const [marketData, setMarketData] = useState({}); 
            const [apiToken, setApiToken] = useState(''); 
            const [fbConfigInput, setFbConfigInput] = useState(localFbConfigStr || ''); 
            const [isUpdating, setIsUpdating] = useState(false);
            const [isMasked, setIsMasked] = useState(false);
            const [showWithDividend, setShowWithDividend] = useState(true); 
            const [selectedStockId, setSelectedStockId] = useState(null);
            const [pendingDeleteId, setPendingDeleteId] = useState(null);
            const [recordSortOrder, setRecordSortOrder] = useState('desc'); 

            const [formCode, setFormCode] = useState('');
            const [formDate, setFormDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState('è²·é€²');
            const [formTotalAmount, setFormTotalAmount] = useState(''); 
            const [formPrice, setFormPrice] = useState('');     
            const [formShares, setFormShares] = useState('');   
            const [formFee, setFormFee] = useState('');         
            const [isSearchingName, setIsSearchingName] = useState(false);
            
            const [isSaving, setIsSaving] = useState(false);
            const [toastMsg, setToastMsg] = useState('');

            useEffect(() => {
                const savedToken = localStorage.getItem(TOKEN_KEY);
                setApiToken(savedToken || MY_TOKEN);
                if (!isFirebaseConfigured || !auth) {
                    const savedTxs = localStorage.getItem(STORAGE_KEY);
                    const savedMaster = localStorage.getItem(MASTER_KEY);
                    if (savedTxs) setTransactions(JSON.parse(savedTxs));
                    if (savedMaster) setStockMaster(JSON.parse(savedMaster));
                    setIsCloudLoading(false);
                    return;
                }
                const unsubscribe = auth.onAuthStateChanged(async (currUser) => {
                    if (!currUser) {
                        try { await auth.signInAnonymously(); } catch (e) {}
                    } else {
                        setUser(currUser);
                        setIsCloudLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isFirebaseConfigured || !user || !db) return;
                const txRef = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions');
                const unsub = txRef.onSnapshot(snap => {
                    setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                const masterRef = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('settings').doc('master');
                const unsubM = masterRef.onSnapshot(doc => {
                    if (doc.exists) setStockMaster(doc.data());
                });
                return () => { unsub(); unsubM(); };
            }, [user]);

            const syncMarketData = async () => {
                if (isUpdating || !apiToken) return;
                const codes = [...new Set(transactions.map(t => t.stockId))];
                if (codes.length === 0) return;
                setIsUpdating(true);
                try {
                    const newMarket = { ...marketData };
                    const dateLimit = new Date(); dateLimit.setDate(dateLimit.getDate() - 7);
                    const dateStr = dateLimit.toISOString().split('T')[0];
                    for (const code of codes) {
                        const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${code}&start_date=${dateStr}&token=${apiToken}`;
                        const resp = await fetch(url);
                        const json = await resp.json();
                        if (json.msg === 'success' && json.data && json.data.length > 0) {
                            const latest = json.data[json.data.length - 1];
                            const prev = json.data.length > 1 ? json.data[json.data.length - 2] : latest;
                            newMarket[code] = { p: latest.close, c: parseFloat((latest.close - prev.close).toFixed(2)) };
                        }
                    }
                    setMarketData(newMarket);
                } catch (e) {} finally { setIsUpdating(false); }
            };

            const fetchStockInfo = async (code) => {
                if (!apiToken) return;
                setIsSearchingName(true);
                try {
                    const resp = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInfo&data_id=${code}&token=${apiToken}`);
                    const json = await resp.json();
                    if (json.msg === 'success' && json.data && json.data.length > 0) {
                        const info = json.data[0];
                        const newM = { ...stockMaster, [code]: { n: info.stock_name, t: code.endsWith('B') ? 'BondETF' : (code.startsWith('00') ? 'StockETF' : 'Stock') } };
                        setStockMaster(newM);
                        if (isFirebaseConfigured && user && db) {
                            await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('settings').doc('master').set(newM);
                        } else {
                            localStorage.setItem(MASTER_KEY, JSON.stringify(newM));
                        }
                    }
                } catch (e) {} finally { setIsSearchingName(false); }
            };

            useEffect(() => {
                const code = formCode.toUpperCase();
                if (code.length < 2) return;
                const t = setTimeout(() => fetchStockInfo(code), 300); // ç¸®çŸ­é˜²æŠ–æ™‚é–“ï¼ŒåŠ å¿«åæ‡‰
                return () => clearTimeout(t);
            }, [formCode, apiToken]);

            const stats = useMemo(() => {
                const inv = {};
                [...transactions].sort((a,b)=>a.timestamp - b.timestamp).forEach(tx => {
                    const id = tx.stockId;
                    if (!inv[id]) inv[id] = { sh: 0, cost: 0, div: 0, realized: 0, n: tx.stockName, history: [] };
                    inv[id].history.push(tx);
                    if (tx.type === 'è²·é€²') { inv[id].sh += tx.shares; inv[id].cost += Math.abs(tx.total); }
                    else if (tx.type === 'è³£å‡º' && inv[id].sh > 0) {
                        const avg = inv[id].cost / inv[id].sh;
                        const soldCost = tx.shares * avg;
                        inv[id].realized += (tx.total - soldCost);
                        inv[id].cost -= soldCost; inv[id].sh -= tx.shares;
                    }
                    else if (tx.type === 'é…æ¯') { inv[id].div += Math.abs(tx.total); }
                });
                let mv = 0, remC = 0, dp = 0, td = 0;
                Object.entries(inv).forEach(([id, d]) => {
                    const m = marketData[id] || { p: 0, c: 0 };
                    mv += d.sh * m.p; remC += d.cost; dp += d.sh * m.c; td += d.div;
                });
                const unrealized = mv - remC;
                const profit = showWithDividend ? unrealized + td : unrealized;
                return { profit, pct: remC > 0 ? (profit/remC*100) : 0, mv, remC, dp, td, inv };
            }, [transactions, marketData, showWithDividend]);

            const calc = useMemo(() => {
                if (activeTab === 'é…æ¯') {
                    if (formTotalAmount) return { total: Math.round(parseFloat(formTotalAmount) || 0), fee: 0, autoFee: 0 };
                    const fee = parseFloat(formFee) || 10;
                    return { total: Math.round((parseFloat(formPrice)||0) * (parseInt(formShares)||0) - fee), fee, autoFee: 0 };
                }
                const amt = (parseFloat(formPrice)||0) * (parseInt(formShares)||0);
                let autoF = Math.floor(amt * 0.001425 * 0.6); if (autoF < 20 && amt > 0) autoF = 20;
                let tr = 0.003; if (formCode.endsWith('B')) tr = 0; else if (formCode.startsWith('00')) tr = 0.001;
                const autoTax = activeTab === 'è³£å‡º' ? Math.floor(amt * tr) : 0;
                const autoTotalFee = autoF + autoTax;
                const finalFee = formFee !== '' ? (parseFloat(formFee) || 0) : autoTotalFee;
                const finalTotal = activeTab === 'è²·é€²' ? -(amt + finalFee) : (amt - finalFee);
                return { total: Math.round(finalTotal), fee: finalFee, autoFee: autoTotalFee };
            }, [formPrice, formShares, formFee, formTotalAmount, activeTab, formCode]);

            // --- ğŸš€ é—œéµå„ªåŒ–ï¼šæ¨‚è§€å­˜æª” (ä¸å†ç­‰å¾…é›²ç«¯å›å‚³æ‰è§£æ”¾ UI) ---
            const saveTx = async (stay) => {
                if (!formCode || (activeTab !== 'é…æ¯' && (!formPrice || !formShares))) {
                    alert("è«‹æ­£ç¢ºå¡«å¯«ä»£è™Ÿèˆ‡è‚¡æ•¸/é‡‘é¡"); return;
                }
                
                const code = formCode.toUpperCase();
                const newTx = {
                    stockId: code, stockName: stockMaster[code]?.n || `æ¨™çš„ ${code}`,
                    type: activeTab, price: parseFloat(formPrice)||0, shares: parseInt(formShares)||0,
                    total: calc.total, date: formDate.replace(/-/g, '/'), timestamp: Date.now()
                };

                // 1. ç«‹å³æ¸…ç©º/é‡ç½® UI (ä¸ç­‰å¾…é›²ç«¯å›å‚³)
                if (stay) {
                    setFormPrice(''); setFormShares(''); setFormFee(''); setFormTotalAmount('');
                    setToastMsg('ğŸ‰ å„²å­˜ä¸­...');
                    setTimeout(() => setToastMsg(''), 2000);
                } else {
                    setView('holding');
                    setFormCode(''); setFormPrice(''); setFormShares(''); setFormFee(''); setFormTotalAmount('');
                }

                // 2. èƒŒæ™¯éåŒæ­¥å„²å­˜ (Fire and Forget)
                const runCloudSave = async () => {
                    try {
                        if (isFirebaseConfigured && user && db) {
                            await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions').add(newTx);
                        } else {
                            newTx.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                            const updated = [newTx, ...transactions];
                            setTransactions(updated);
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                        }
                    } catch (e) {
                        console.error("Save failed in background", e);
                        alert("éƒ¨åˆ†è³‡æ–™å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼");
                    }
                };
                runCloudSave(); 
            };

            const confirmDelete = async () => {
                const idToDelete = pendingDeleteId;
                setPendingDeleteId(null); // ç«‹å³é—œé–‰è¦–çª—
                if (isFirebaseConfigured && user && db && idToDelete) {
                    await db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions').doc(idToDelete).delete();
                } else {
                    const updated = transactions.filter(t => t.id !== idToDelete);
                    setTransactions(updated);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                }
            };

            const handleSaveToken = (t) => { setApiToken(t); localStorage.setItem(TOKEN_KEY, t); };
            const handleSaveFbConfig = () => {
                let input = fbConfigInput.trim();
                try {
                    if (input.includes('=')) input = input.substring(input.indexOf('=') + 1).trim();
                    if (input.endsWith(';')) input = input.slice(0, -1).trim();
                    const parsed = new Function("return " + input)();
                    localStorage.setItem('stockify_firebase_config', JSON.stringify(parsed));
                    alert("Firebase è¨­å®šå·²æ›´æ–°ã€‚"); window.location.reload();
                } catch(e) { alert("è§£æå¤±æ•—"); }
            };
            const handleClearFbConfig = () => { localStorage.removeItem('stockify_firebase_config'); window.location.reload(); };

            const handleImport = (e) => {
                const reader = new FileReader();
                reader.onload = async (ev) => { 
                    try {
                        const importedData = JSON.parse(ev.target.result);
                        if(!Array.isArray(importedData)) throw new Error("Format error");
                        setIsSaving(true);
                        if (isFirebaseConfigured && user && db) {
                            const txCollection = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('transactions');
                            const batch = db.batch();
                            importedData.forEach(item => {
                                const { id, ...cleanItem } = item;
                                const newDoc = txCollection.doc(); batch.set(newDoc, cleanItem);
                            });
                            await batch.commit();
                            alert("é›²ç«¯è³‡æ–™åŒæ­¥å®Œæˆï¼");
                        } else {
                            setTransactions(importedData); localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
                            alert("å–®æ©Ÿè³‡æ–™åŒ¯å…¥å®Œæˆï¼");
                        }
                        setView('holding');
                    } catch (err) { alert("åŒ¯å…¥å¤±æ•—"); } finally { setIsSaving(false); }
                };
                if(e.target.files[0]) reader.readAsText(e.target.files[0]);
            };

            const Mask = ({ val }) => isMasked ? "****" : <span className={val >= 0 ? 'text-red-500' : 'text-green-600'}>{val.toLocaleString(undefined, {maximumFractionDigits:0})}</span>;

            if (isCloudLoading || isSaving) return <div className="h-full w-full flex flex-col items-center justify-center bg-white"><div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div><p className="font-black text-blue-500 italic uppercase tracking-widest">Syncing Cloud...</p></div>;

            return (
                <div className="app-container h-full w-full max-w-screen-sm mx-auto flex flex-col relative bg-white overflow-hidden shadow-2xl">
                    <div className="flex-1 flex flex-col overflow-hidden relative bg-white">
                        
                        {/* 1. é¦–é  (æŒè‚¡) */}
                        {view === 'holding' && (
                            <React.Fragment>
                                <div className="p-4 sm:p-6 flex justify-between items-center border-b border-gray-50 bg-white shrink-0">
                                    <div className="flex flex-col">
                                        <h1 className="text-2xl sm:text-3xl font-black italic text-gray-800 tracking-tighter">St<span className="text-blue-600">o</span>ckify</h1>
                                        <p className="text-[9px] sm:text-[10px] text-gray-400 font-bold ml-1 uppercase tracking-widest">{APP_VERSION} â€¢ {isFirebaseConfigured ? 'Cloud' : 'Local'}</p>
                                    </div>
                                    <div className="flex space-x-2 sm:space-x-3">
                                        <button onClick={() => setIsMasked(!isMasked)} className="p-2 text-gray-300 active:scale-95"><Icon name="RotateCcw" className="w-6 h-6"/></button>
                                        <button onClick={() => setView('settings')} className="p-2 text-gray-400 active:scale-95"><Icon name="Settings" className="w-6 h-6"/></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto overflow-x-hidden content-pb">
                                    <div className="px-5 py-6">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-gray-400 font-bold text-xs uppercase tracking-widest">{showWithDividend ? 'ç´¯ç©æç›Š (å«æ¯)' : 'æœªå¯¦ç¾æç›Š'}</span>
                                            <button onClick={() => setShowWithDividend(!showWithDividend)} className={`px-2 py-1 rounded-lg border text-[10px] font-black flex items-center space-x-1 ${showWithDividend ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-gray-50 text-gray-400 border-gray-100'}`}>
                                                {showWithDividend ? <Icon name="ToggleRight" className="w-5 h-5"/> : <Icon name="ToggleLeft" className="w-5 h-5"/>} <span>{showWithDividend ? 'å«æ¯' : 'é™¤æ¯'}</span>
                                            </button>
                                        </div>
                                        <div className="flex items-baseline space-x-2 mt-1">
                                            <span className="text-4xl sm:text-5xl font-black tabular-nums tracking-tighter"><Mask val={stats.profit} /></span>
                                            <span className={`text-base sm:text-xl font-black ${stats.profit >= 0 ? 'text-red-500' : 'text-green-600'}`}>{isMasked ? '***' : `${stats.profit >= 0 ? '+' : ''}${stats.pct.toFixed(2)}%`}</span>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 px-2 py-5 border-y border-gray-100 bg-gray-50/40">
                                        <div className="text-center"><p className="text-gray-400 font-black text-[9px] uppercase tracking-tighter">ä»Šæ—¥æç›Š</p><p className="font-black text-base mt-1"><Mask val={stats.dp} /></p></div>
                                        <div className="text-center border-x border-gray-200"><p className="text-gray-400 font-black text-[9px] uppercase tracking-tighter">æŒè‚¡å¸‚å€¼</p><p className="font-black text-base mt-1 text-gray-800">{isMasked ? '****' : stats.mv.toLocaleString()}</p></div>
                                        <div className="text-center"><p className="text-gray-400 font-black text-[9px] uppercase text-red-500">ç´¯ç©é…æ¯</p><p className="font-black text-base mt-1 text-gray-800">{isMasked ? '****' : stats.td.toLocaleString()}</p></div>
                                    </div>
                                    <div className="flex px-5 py-3 text-[10px] text-gray-400 font-black uppercase border-b border-gray-50 bg-white sticky top-0 z-10">
                                        <span className="w-[34%]">æ¨™çš„ / è‚¡æ•¸</span>
                                        <span className="w-[22%] text-right">ç¾åƒ¹</span>
                                        <span className="w-[22%] text-right">{showWithDividend ? 'å«æ¯' : 'å¹³å‡'}</span>
                                        <span className="w-[22%] text-right">æç›Š</span>
                                    </div>
                                    {Object.entries(stats.inv).map(([id, d]) => d.sh > 0 && (
                                        <div key={id} onClick={() => { setSelectedStockId(id); setView('detail'); }} className="flex px-5 py-5 border-b border-gray-50 items-center active:bg-gray-50 cursor-pointer transition-colors">
                                            <div className="w-[34%] pr-1 min-w-0"><p className="font-black text-sm sm:text-lg leading-tight truncate">{d.n}</p><p className="text-[10px] text-gray-400 truncate mt-0.5">{id} / {d.sh.toLocaleString()}</p></div>
                                            <div className="w-[22%] text-right min-w-0 pr-1"><p className="font-black text-sm sm:text-lg truncate">{marketData[id]?.p || "---"}</p><p className={`text-[9px] font-bold mt-0.5 truncate ${marketData[id]?.c >= 0 ? 'text-red-500' : 'text-green-600'}`}>{marketData[id]?.c >= 0 ? 'â–²' : 'â–¼'} {Math.abs(marketData[id]?.c || 0)}</p></div>
                                            <div className="w-[22%] text-right font-bold text-gray-600 text-xs sm:text-base truncate pr-1">{isMasked ? '***' : ((d.cost - (showWithDividend?d.div:0))/d.sh).toFixed(2)}</div>
                                            <div className="w-[22%] text-right font-black text-sm sm:text-lg truncate pl-1"><Mask val={(d.sh*(marketData[id]?.p||0)) - d.cost + (showWithDividend?d.div:0)} /></div>
                                        </div>
                                    ))}
                                </div>
                            </React.Fragment>
                        )}

                        {/* 2. äº¤æ˜“ç´€éŒ„ */}
                        {view === 'record' && (
                            <div className="flex flex-col h-full animate-in fade-in bg-white">
                                <div className="p-4 flex justify-between items-center border-b border-gray-50 bg-white shrink-0">
                                    <h1 className="text-2xl font-black italic text-gray-800">äº¤æ˜“æµæ°´å¸³</h1>
                                    <button onClick={() => setRecordSortOrder(recordSortOrder === 'desc' ? 'asc' : 'desc')} className="p-2 bg-gray-50 rounded-xl active:scale-95"><Icon name="ArrowUpDown" className="w-6 h-6"/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto content-pb">
                                    {(() => {
                                        const groups = {};
                                        [...transactions].sort((a,b)=>recordSortOrder==='desc' ? b.timestamp-a.timestamp : a.timestamp-b.timestamp).forEach(tx => {
                                            if (!groups[tx.date]) groups[tx.date] = { txs: [], exp: 0 };
                                            groups[tx.date].txs.push(tx);
                                            if (tx.type === 'è²·é€²') groups[tx.date].exp += Math.abs(tx.total);
                                        });
                                        return Object.entries(groups).map(([date, g]) => (
                                            <div key={date}>
                                                <div className="bg-gray-50 px-5 py-2 flex justify-between items-center border-b border-gray-100 font-black text-gray-400 text-[10px]"><span>{date}</span><span>æ”¯å‡º: {g.exp.toLocaleString()}</span></div>
                                                {g.txs.map(tx => (
                                                    <div key={tx.id} className="flex px-5 py-5 border-b border-gray-100 items-center hover:bg-gray-50">
                                                        <span className="w-[35%] font-black text-sm sm:text-lg truncate pr-1">{tx.stockName}</span>
                                                        <span className="w-[20%] text-center font-bold text-gray-500 text-[10px] leading-tight truncate">{tx.type}<br/>{tx.shares.toLocaleString()}è‚¡</span>
                                                        <span className="w-[20%] text-right font-black text-sm truncate px-1">{tx.price.toLocaleString()}</span>
                                                        <div className="w-[25%] flex items-center justify-end space-x-1 truncate">
                                                            <span className={`font-black text-sm ${tx.total >= 0 ? 'text-red-500' : 'text-green-600'}`}>{tx.total.toLocaleString()}</span>
                                                            <button onClick={()=>setPendingDeleteId(tx.id)} className="text-gray-300 p-1 active:text-red-500"><Icon name="Trash" className="w-5 h-5"/></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ));
                                    })()}
                                </div>
                            </div>
                        )}

                        {/* 3. è‚¡æ¯çµ±è¨ˆ */}
                        {view === 'dividend' && (
                            <div className="flex flex-col h-full animate-in fade-in bg-white">
                                <div className="p-4 flex justify-between items-center border-b border-gray-50 bg-white shrink-0"><h1 className="text-2xl font-black italic text-gray-800 tracking-tighter">è‚¡æ¯çµ±è¨ˆ</h1><Icon name="Coins" className="w-7 h-7 text-blue-500"/></div>
                                <div className="flex-1 overflow-y-auto content-pb p-4 space-y-6">
                                    {(() => {
                                        const years = {};
                                        transactions.filter(t => t.type === 'é…æ¯').forEach(tx => {
                                            const year = tx.date.split('/')[0];
                                            if (!years[year]) years[year] = { stocks: {}, total: 0 };
                                            if (!years[year].stocks[tx.stockId]) years[year].stocks[tx.stockId] = { n: tx.stockName, amt: 0 };
                                            years[year].stocks[tx.stockId].amt += Math.abs(tx.total);
                                            years[year].total += Math.abs(tx.total);
                                        });
                                        return Object.entries(years).sort((a,b) => b[0] - a[0]).map(([y, d]) => (
                                            <div key={y} className="bg-gray-50 rounded-2xl overflow-hidden border border-gray-100 shadow-sm">
                                                <div className="bg-blue-600 px-5 py-4 flex justify-between items-center text-white"><span className="text-xl font-black">{y} å¹´åº¦</span><div className="text-right"><p className="text-[10px] font-black opacity-60">å¹´åº¦ç¸½é¡</p><p className="text-lg font-black">${d.total.toLocaleString()}</p></div></div>
                                                <div className="p-4 space-y-3">{Object.entries(d.stocks).map(([id, s]) => (<div key={id} className="flex justify-between items-center px-2 border-b border-gray-100 pb-3 last:border-0 last:pb-0"><div className="flex flex-col"><span className="font-black text-base text-gray-800">{s.n}</span><span className="text-[10px] font-black text-gray-400">{id}</span></div><span className="text-lg font-black text-red-500 tabular-nums">${s.amt.toLocaleString()}</span></div>))}</div>
                                            </div>
                                        ));
                                    })()}
                                </div>
                            </div>
                        )}

                        {/* 4. è¨­å®šé é¢ */}
                        {view === 'settings' && (
                            <div className="flex flex-col h-full animate-in slide-in-from-right bg-white z-[70]">
                                <div className="p-4 flex items-center border-b border-gray-50 bg-white sticky top-0 shrink-0"><button onClick={() => setView('holding')} className="p-1"><Icon name="ChevronLeft" className="w-10 h-10"/></button><h2 className="flex-1 text-center font-black text-xl uppercase tracking-tighter">ç³»çµ±è¨­å®š</h2><div className="w-10"></div></div>
                                <div className="p-6 space-y-6 flex-1 overflow-y-auto content-pb">
                                    <div className="space-y-3">
                                        <label className="flex items-center text-xs font-black uppercase text-gray-400 tracking-widest"><Icon name="Key" className="w-5 h-5 mr-2"/> FinMind é‡‘é‘°</label>
                                        <input type="password" placeholder="è²¼ä¸Š Token..." className="w-full bg-gray-50 p-5 rounded-2xl outline-none font-black" value={apiToken} onChange={e => handleSaveToken(e.target.value)} />
                                    </div>
                                    <div className="space-y-3">
                                        <label className="flex items-center text-xs font-black uppercase text-gray-400 tracking-widest"><Icon name="Cloud" className="w-5 h-5 mr-2 text-blue-500"/> Firebase é›²ç«¯è¨­å®š</label>
                                        <textarea className="w-full h-32 bg-blue-50/30 p-4 rounded-2xl outline-none font-mono text-xs text-gray-600" value={fbConfigInput} onChange={e => setFbConfigInput(e.target.value)} />
                                        <div className="flex space-x-2">
                                            <button onClick={handleSaveFbConfig} className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-md">å„²å­˜è¨­å®š</button>
                                            <button onClick={handleClearFbConfig} className="flex-1 py-4 bg-gray-100 text-gray-600 rounded-2xl font-black">åˆ‡å›å–®æ©Ÿ</button>
                                        </div>
                                    </div>
                                    <div className="h-px bg-gray-100"></div>
                                    <button onClick={() => { const b = new Blob([JSON.stringify(transactions)], {type: 'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'stockify_backup.json'; a.click(); }} className="w-full py-5 bg-gray-900 text-white rounded-2xl font-black flex items-center justify-center space-x-2"><Icon name="Download" className="w-6 h-6"/><span>åŒ¯å‡ºå‚™ä»½ (.json)</span></button>
                                    <label className="w-full py-5 border-2 border-gray-200 text-gray-500 rounded-2xl font-black flex items-center justify-center space-x-2 cursor-pointer active:bg-gray-50">
                                        <Icon name="Upload" className="w-6 h-6"/><span>åŒ¯å…¥ç´€éŒ„æª”</span>
                                        <input type="file" className="hidden" accept=".json" onChange={handleImport} />
                                    </label>
                                    <div className="text-center bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                        <p className="text-gray-400 font-black text-[10px] uppercase tracking-widest mb-1">Account Info</p>
                                        <p className="text-gray-600 font-mono text-[10px] break-all leading-tight">UID: {user?.uid || 'LocalStorage'}<br/>Mode: {isFirebaseConfigured ? 'CLOUD' : 'LOCAL'}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 5. æ–°å¢ç´€éŒ„ (âš ï¸ æ¨‚è§€æ›´æ–°å„ªåŒ–) */}
                        {view === 'add' && (
                            <div className="flex flex-col h-full w-full bg-white z-[100] animate-in slide-in-from-bottom-4">
                                <div className="p-4 flex items-center border-b border-gray-50 bg-white shrink-0">
                                    <button onClick={() => setView('holding')} className="p-1 active:scale-90"><Icon name="ChevronLeft" className="w-10 h-10"/></button>
                                    <h2 className="flex-1 text-center font-black text-xl uppercase tracking-tighter">æ–°å¢ç´€éŒ„</h2>
                                    <div className="w-10"></div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 bg-white">
                                    <div className="max-w-md mx-auto space-y-8 pb-32">
                                        {toastMsg && <div className="p-4 bg-green-50 text-green-700 rounded-2xl flex items-center justify-center font-bold text-sm shadow-sm animate-in zoom-in-95"><Icon name="CheckCircle2" className="w-6 h-6 mr-2" /> {toastMsg}</div>}
                                        <div className="space-y-3">
                                            <div className="flex items-center space-x-3"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">ä»£è™Ÿ</label><input className="flex-1 bg-gray-50 p-5 rounded-2xl outline-none font-black text-2xl uppercase" placeholder="2330" value={formCode} onChange={e=>setFormCode(e.target.value)} /></div>
                                            <div className="pl-[76px] font-black text-blue-600 text-lg min-h-[28px]">{isSearchingName ? "Searching..." : (stockMaster[formCode.toUpperCase()]?.n || "è¼¸å…¥ä»£è™Ÿç¢ºèª")}</div>
                                        </div>
                                        <div className="flex items-center space-x-3"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">æ—¥æœŸ</label><div className="flex-1 relative"><input type="date" className="w-full bg-gray-50 p-5 rounded-2xl outline-none font-black text-base" value={formDate} onChange={e=>setFormDate(e.target.value)} /><Icon name="Calendar" className="absolute right-5 top-1/2 -translate-y-1/2 text-gray-300 w-6 h-6 pointer-events-none"/></div></div>
                                        <div className="flex items-center space-x-3"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">å‹•ä½œ</label><div className="flex flex-1 space-x-2">{['è²·é€²','è³£å‡º','é…æ¯'].map(t=>(<button key={t} onClick={()=>{setActiveTab(t); setFormPrice(''); setFormShares(''); setFormFee(''); setFormTotalAmount('');}} className={`flex-1 py-4 rounded-xl text-lg font-black transition-all ${activeTab===t?'bg-blue-600 text-white shadow-md':'bg-gray-100 text-gray-400'}`}>{t}</button>))}</div></div>
                                        <div className="space-y-6 pt-4 border-t border-gray-50">
                                            {activeTab === 'é…æ¯' ? (
                                                <React.Fragment>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">é‡‘é¡</label><input type="number" value={formTotalAmount} onChange={e=>setFormTotalAmount(e.target.value)} className="flex-1 ml-3 outline-none font-black text-2xl text-blue-600 bg-transparent" placeholder="0" /></div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">æ¯è‚¡æ¯</label><input type="number" value={formPrice} onChange={e=>setFormPrice(e.target.value)} className="flex-1 ml-3 outline-none font-black text-2xl bg-transparent" placeholder="0.00" /></div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">è‚¡æ•¸</label><input type="number" value={formShares} onChange={e=>setFormShares(e.target.value)} className="flex-1 ml-3 outline-none font-black text-2xl bg-transparent" placeholder="0" /></div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">åŒ¯è²»</label><input type="number" value={formFee} onChange={e=>setFormFee(e.target.value)} className="flex-1 ml-3 outline-none font-black text-2xl bg-transparent text-gray-400" placeholder="10" /></div>
                                                </React.Fragment>
                                            ) : (
                                                <React.Fragment>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">åƒ¹æ ¼</label><input type="number" value={formPrice} onChange={e=>setFormPrice(e.target.value)} className="flex-1 ml-3 outline-none font-black text-2xl bg-transparent" placeholder="0.00" /></div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">è‚¡æ•¸</label><input type="number" value={formShares} onChange={e=>setFormShares(e.target.value)} className="flex-1 ml-3 outline-none font-black text-2xl bg-transparent" placeholder="0" /></div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-xs uppercase w-16 shrink-0">æ‰‹çºŒ/ç¨…</label><input type="number" value={formFee} onChange={e=>setFormFee(e.target.value)} className="flex-1 ml-3 outline-none font-black text-2xl bg-transparent text-gray-500" placeholder={calc.autoFee > 0 ? calc.autoFee.toString() : "è‡ªå‹•é ä¼°"} /></div>
                                                </React.Fragment>
                                            )}
                                        </div>
                                        <div className="bg-blue-50/50 p-6 rounded-3xl border border-blue-100/50 mt-8 mb-20"><div className="flex justify-between font-black text-blue-900 items-baseline"><span className="text-sm shrink-0">{activeTab==='è²·é€²'?'ç¸½æ”¯å‡º':activeTab==='è³£å‡º'?'ç¸½æ”¶å…¥':'é ˜æ¯å…¥å¸³'}</span><span className="text-3xl tabular-nums tracking-tighter truncate pl-4">$ {Math.abs(calc.total).toLocaleString()}</span></div></div>
                                    </div>
                                </div>
                                <div className="sticky bottom-0 shrink-0 p-4 grid grid-cols-2 gap-4 border-t border-gray-100 bg-white safe-pb shadow-[0_-15px_30px_rgba(0,0,0,0.05)]">
                                    <button onClick={()=>saveTx(true)} className="py-4 border-2 border-blue-600 text-blue-600 rounded-2xl font-black text-lg active:scale-95 transition-all flex justify-center items-center h-[60px]">å†è¨˜ä¸€ç­†</button>
                                    <button onClick={()=>saveTx(false)} className="py-4 bg-blue-600 text-white rounded-2xl font-black text-lg shadow-lg active:scale-95 flex justify-center items-center h-[60px]">å®Œæˆå­˜æª”</button>
                                </div>
                            </div>
                        )}

                        {/* 6. å€‹è‚¡è©³æƒ… */}
                        {view === 'detail' && selectedStockId && (
                           <div className="flex flex-col h-full animate-in slide-in-from-right bg-white overflow-hidden">
                               <div className="p-4 flex items-center border-b border-gray-50 bg-white shrink-0"><button onClick={() => setView('holding')} className="p-1 active:scale-90"><Icon name="ChevronLeft" className="w-10 h-10"/></button><h2 className="flex-1 text-center font-black text-xl uppercase tracking-tighter">{selectedStockId} {stockMaster[selectedStockId]?.n}</h2><button onClick={()=>{setFormCode(selectedStockId); setView('add');}} className="text-blue-500 p-1 active:scale-90"><Icon name="Plus" className="w-8 h-8"/></button></div>
                               <div className="flex-1 overflow-y-auto content-pb">
                                   {(() => {
                                       const d = stats.inv[selectedStockId]; if (!d) return null;
                                       const m = marketData[selectedStockId] || { p: 0, c: 0 };
                                       const profit = showWithDividend ? (d.sh * m.p - d.cost + d.div) : (d.sh * m.p - d.cost);
                                       const avg = d.sh > 0 ? (showWithDividend ? (d.cost - d.div)/d.sh : d.cost/d.sh) : 0;
                                       return (
                                           <div className="flex flex-col">
                                               <div className={`p-6 flex justify-between items-center ${m.c >= 0 ? 'bg-red-50' : 'bg-green-50'}`}><div className={`text-2xl font-black ${m.c >= 0 ? 'text-red-500' : 'text-green-600'}`}>{m.p} <span className="text-sm font-bold ml-1">{m.c >= 0 ? 'â–²' : 'â–¼'} {Math.abs(m.c)}</span></div><button onClick={()=>setShowWithDividend(!showWithDividend)} className="px-3 py-1.5 rounded-full bg-white border border-gray-200 text-xs font-black shadow-sm flex items-center space-x-1 transition-all active:scale-95">{showWithDividend ? <Icon name="ToggleRight" size={18} className="text-blue-500"/> : <Icon name="ToggleLeft" size={18} className="text-gray-300"/>} <span>{showWithDividend ? 'å«æ¯' : 'é™¤æ¯'}</span></button></div>
                                               <div className="p-8 border-b border-gray-50"><p className="text-gray-400 text-xs font-black uppercase mb-1">{showWithDividend ? 'ç´¯ç©æç›Š (å«æ¯)' : 'æŒè‚¡æç›Š'}</p><h3 className="text-4xl font-black tabular-nums tracking-tighter"><Mask val={profit} /></h3>
                                                   <div className="grid grid-cols-3 gap-y-8 mt-10 text-center text-[12px]">
                                                       <div className="text-left"><p className="text-gray-400 font-black uppercase tracking-tighter">å¹³å‡æˆæœ¬</p><p className="font-black text-xl text-gray-800">{isMasked ? '***' : avg.toFixed(2)}</p></div>
                                                       <div><p className="text-gray-400 font-black uppercase text-blue-600 tracking-tighter">å·²å¯¦ç¾</p><p className="font-black text-xl"><Mask val={d.realized} /></p></div>
                                                       <div className="text-right"><p className="text-gray-400 font-black uppercase tracking-tighter">ç›®å‰æŒè‚¡</p><p className="font-black text-xl text-gray-800">{d.sh.toLocaleString()}</p></div>
                                                       <div className="text-left"><p className="text-gray-400 font-black uppercase tracking-tighter">æŒè‚¡å¸‚å€¼</p><p className="font-black text-xl text-gray-800">{(d.sh * m.p).toLocaleString(undefined, {maximumFractionDigits:0})}</p></div>
                                                       <div><p className="text-gray-400 font-black uppercase tracking-tighter">ä»Šæ—¥ç›ˆè™§</p><p className="font-black text-xl"><Mask val={d.sh * m.c} /></p></div>
                                                       <div className="text-right"><p className="text-gray-400 font-black uppercase tracking-tighter text-red-500">ç´¯è¨ˆé ˜æ¯</p><p className="font-black text-xl text-gray-800">{d.div.toLocaleString()}</p></div>
                                                   </div>
                                               </div>
                                               <div className="bg-gray-50/40 pb-32">
                                                   <div className="grid grid-cols-4 px-6 py-3 text-[10px] text-gray-400 font-black border-b border-gray-100"><span>æ—¥æœŸ</span><span className="text-center">äº¤æ˜“</span><span className="text-right">å–®åƒ¹</span><span className="text-right">æ”¶æ”¯</span></div>
                                                   {d.history.sort((a,b)=>b.timestamp-a.timestamp).map(tx => (<div key={tx.id} className="grid grid-cols-4 px-6 py-6 border-b border-gray-50 items-center hover:bg-white transition-colors text-sm"><span className="font-black text-gray-400">{tx.date.substring(5)}</span><span className="text-center font-black text-gray-800">{tx.type} {tx.shares > 0 ? `${tx.shares}è‚¡` : ''}</span><span className="text-right font-black">{tx.price > 0 ? tx.price : '-'}</span><div className="text-right flex items-center justify-end space-x-3"><Mask val={tx.total} /><button onClick={()=>setPendingDeleteId(tx.id)} className="text-gray-300 hover:text-red-400 p-1"><Icon name="Trash" size={20}/></button></div></div>))}
                                               </div>
                                           </div>
                                       );
                                   })()}
                               </div>
                           </div>
                        )}
                    </div>

                    {/* åº•éƒ¨å°è¦½åˆ— */}
                    {(view === 'holding' || view === 'record' || view === 'dividend') && (
                        <React.Fragment>
                            <div className="absolute left-4 right-4 h-16 sm:h-20 bg-white/90 backdrop-blur-2xl border border-white/50 rounded-2xl sm:rounded-[32px] flex items-center justify-between px-2 sm:px-6 z-50 shadow-[0_20px_50px_rgba(0,0,0,0.1)] nav-island">
                                <div className="flex flex-1 justify-around items-center pr-10">
                                    <button onClick={() => setView('holding')} className={`flex flex-col items-center ${view==='holding'?'text-blue-600':'text-gray-300'} active:scale-95`}><Icon name="PieChart" className="w-7 h-7"/><span className="text-[10px] font-black mt-1 uppercase">æŒè‚¡</span></button>
                                    <button onClick={() => setView('record')} className={`flex flex-col items-center ${view==='record'?'text-blue-600':'text-gray-300'} active:scale-95`}><Icon name="History" className="w-7 h-7"/><span className="text-[10px] font-black mt-1 uppercase">ç´€éŒ„</span></button>
                                </div>
                                <div className="flex flex-1 justify-around items-center pl-10">
                                    <button onClick={() => setView('dividend')} className={`flex flex-col items-center ${view==='dividend'?'text-blue-600':'text-gray-300'} active:scale-95`}><Icon name="Coins" className="w-7 h-7"/><span className="text-[10px] font-black mt-1 uppercase">è‚¡æ¯</span></button>
                                    <button onClick={syncMarketData} className={`flex flex-col items-center ${isUpdating?'animate-spin text-blue-400':'text-gray-300'} active:scale-95`}><Icon name="Refresh" className="w-7 h-7"/><span className="text-[10px] font-black mt-1 uppercase">åŒæ­¥</span></button>
                                </div>
                            </div>
                            <button onClick={() => { setFormCode(''); setView('add'); }} className="absolute left-1/2 -translate-x-1/2 w-16 sm:w-20 h-16 sm:h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white z-[60] shadow-xl border-[6px] border-white active:scale-90 transition-all fab-btn"><Icon name="Plus" className="w-8 h-8 sm:w-10 sm:h-10"/></button>
                        </React.Fragment>
                    )}

                    {/* åˆªé™¤ç¢ºèª */}
                    {pendingDeleteId && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-in zoom-in-95"><div className="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500"><Icon name="AlertCircle" className="w-8 h-8" /></div><h3 className="text-xl font-black text-center mb-2">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3><div className="grid grid-cols-2 gap-4 mt-6"><button onClick={()=>setPendingDeleteId(null)} className="py-4 bg-gray-100 rounded-2xl font-black text-gray-500 active:scale-95">å–æ¶ˆ</button><button onClick={confirmDelete} className="py-4 bg-red-500 rounded-2xl font-black text-white shadow-md active:scale-95">ç¢ºèª</button></div></div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
