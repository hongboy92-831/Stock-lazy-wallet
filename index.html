<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€€ä¼‘æ‡¶éŒ¢åŒ… v1.5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap');
        
        body { 
            font-family: 'Noto+Sans+TC', sans-serif; 
            background-color: #0b1120; 
            color: #f8fafc; 
        }
        
        .number-font { font-family: 'Space Grotesk', monospace; }
        
        .stock-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .stock-card:active { transform: scale(0.97); }
        
        .up-color { color: #ef4444; } /* å°ç£ç´…æ¼² */
        .down-color { color: #22c55e; } /* å°ç£ç¶ è·Œ */
        
        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 10px rgba(239, 68, 68, 0); }
            50% { text-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        }
        
        .live-update { animation: pulse-glow 2s infinite; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* è¼•é‡æ¨æ’­å‹•ç•« */
        @keyframes slide-down {
            0% { transform: translateY(-150%); opacity: 0; }
            10% { transform: translateY(0); opacity: 1; }
            90% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-150%); opacity: 0; }
        }
        
        .toast-notification { animation: slide-down 6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body class="pb-24">

    <!-- ç³»çµ±é€šçŸ¥æ¨æ’­ -->
    <div id="toast-container" class="fixed top-4 left-0 right-0 z-50 flex justify-center hidden pointer-events-none">
        <div class="bg-indigo-600/95 backdrop-blur-md border border-indigo-400/50 text-white px-5 py-3 rounded-2xl shadow-2xl shadow-indigo-900/50 flex items-center gap-3 max-w-sm w-[90%] pointer-events-auto">
            <i data-lucide="bell-ring" class="w-5 h-5 text-yellow-300"></i>
            <div class="flex-1">
                <p class="text-xs font-bold text-indigo-100">ç³»çµ±é€šçŸ¥</p>
                <p class="text-sm font-medium">æ­¡è¿ä½¿ç”¨é€€ä¼‘æ‡¶éŒ¢åŒ…ï¼<br><span class="text-[10px] text-indigo-200">æ‚¨ç›®å‰çš„è³‡ç”¢è³‡æ–™ç‚ºç©ºï¼Œè«‹é€éä¸‹æ–¹ã€Œè¨˜å¸³ã€é–‹å§‹æ‚¨çš„æ—…ç¨‹ã€‚</span></p>
            </div>
            <button onclick="document.getElementById('toast-container').style.display='none'" class="p-1">
                <i data-lucide="x" class="w-4 h-4 opacity-70"></i>
            </button>
        </div>
    </div>

    <!-- ç‰ˆæœ¬è™Ÿèˆ‡é ‚éƒ¨ç‹€æ…‹ -->
    <div class="p-4 flex justify-between items-center text-xs text-slate-500 border-b border-slate-800/50">
        <span class="flex items-center gap-2">
            é€€ä¼‘æ‡¶éŒ¢åŒ… 
            <span class="bg-indigo-900/50 text-indigo-400 border border-indigo-700/50 px-2 py-0.5 rounded font-bold number-font">v1.5.2</span>
        </span>
        <div class="flex items-center gap-2">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
            </span>
            <span id="exchange-rate" class="number-font">USD/TWD 32.50</span>
        </div>
    </div>

    <!-- ç¸½è³‡ç”¢å„€è¡¨æ¿ -->
    <header class="px-6 py-6 bg-gradient-to-b from-slate-900 to-transparent">
        <div class="flex justify-between items-end mb-1">
            <p class="text-slate-400 text-sm font-medium flex items-center gap-1">
                ç¸½è³‡ç”¢å¸‚å€¼ (TWD) <i data-lucide="info" class="w-3 h-3 text-slate-500"></i>
            </p>
            <p class="text-[10px] text-slate-500">å·²æ‰£é™¤é ä¼°ç¨…è²»</p>
        </div>
        
        <div class="flex flex-col mb-2">
            <h1 id="total-assets" class="text-5xl font-bold tracking-tight number-font live-update">$0</h1>
        </div>
        
        <div class="flex items-center gap-3 bg-slate-800/40 p-3 rounded-2xl border border-slate-700/50 backdrop-blur-sm mt-4">
            <div class="p-2 bg-slate-500/10 rounded-xl" id="today-icon-bg">
                <i data-lucide="activity" class="w-5 h-5 text-slate-400" id="today-icon"></i>
            </div>
            <div>
                <p class="text-xs text-slate-400">ä»Šæ—¥å¸³é¢è·³å‹•</p>
                <div class="flex items-baseline gap-2">
                    <p id="today-pnl-value" class="text-xl font-bold text-slate-400 number-font">+$0</p>
                    <span id="total-pnl" class="text-sm font-medium text-slate-400 bg-slate-500/10 px-1.5 py-0.5 rounded number-font">0.00%</span>
                </div>
            </div>
        </div>
    </header>

    <!-- æ ¸å¿ƒåˆ‡æ›åŠŸèƒ½ (å«æ¯æˆæœ¬èˆ‡å°ç¾è‚¡) -->
    <section class="px-6 py-2 flex items-center justify-between sticky top-0 z-30 bg-[#0b1120]/90 backdrop-blur-md pt-4 pb-4">
        <div class="flex bg-slate-800 p-1 rounded-xl shadow-inner">
            <button onclick="switchTab('tw')" id="tab-tw" class="px-5 py-2 rounded-lg text-sm font-bold bg-slate-700 shadow text-white transition-all flex items-center gap-1">
                ğŸ‡¹ğŸ‡¼ å°è‚¡ <span class="text-[10px] font-normal opacity-70">90%</span>
            </button>
            <button onclick="switchTab('us')" id="tab-us" class="px-5 py-2 rounded-lg text-sm font-bold text-slate-400 transition-all flex items-center gap-1">
                ğŸ‡ºğŸ‡¸ ç¾è‚¡ <span class="text-[10px] font-normal opacity-70">10%</span>
            </button>
        </div>
        
        <div class="flex items-center gap-2 bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700">
            <span class="text-xs text-slate-300 font-medium">å«æ¯æˆæœ¬</span>
            <button onclick="toggleDividendAdjusted()" id="dividend-toggle" class="relative inline-flex h-5 w-9 items-center rounded-full bg-slate-600 transition-colors focus:outline-none">
                <span id="toggle-circle" class="inline-block h-3.5 w-3.5 transform rounded-full bg-white transition-transform translate-x-1 shadow-sm"></span>
            </button>
        </div>
    </section>

    <!-- å¡ç‰‡å¼è³‡ç”¢åˆ—è¡¨ -->
    <main id="stock-list" class="px-6 py-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- å¡ç‰‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
    </main>

    <!-- å®‰å…¨è­·åŸæ²³ (å›ºå®šå³ä¸‹è§’) -->
    <div id="safety-corner" class="fixed bottom-24 right-6 z-10">
        <button onclick="toggleSafetyModal()" class="bg-indigo-600 hover:bg-indigo-500 p-3.5 rounded-full shadow-lg shadow-indigo-900/50 border border-indigo-400/30 transition-all active:scale-90 flex items-center justify-center">
            <i data-lucide="shield-check" class="text-white w-6 h-6"></i>
        </button>
    </div>

    <!-- åº•éƒ¨æ¥µç°¡å°èˆª -->
    <nav class="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-xl border-t border-slate-800 px-6 py-3 flex justify-between items-center z-20 pb-safe">
        <div class="flex flex-col items-center text-sky-400 cursor-pointer w-1/4">
            <i data-lucide="radar" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-bold tracking-wider">è·³å‹•</span>
        </div>
        <div class="flex flex-col items-center text-slate-500 hover:text-slate-300 cursor-pointer transition-colors w-1/4" onclick="showDividendRecordModal()">
            <i data-lucide="book-open" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-medium tracking-wider">é ˜æ¯ç´€éŒ„</span>
        </div>
        
        <!-- æ¥µé€Ÿè¨˜å¸³æŒ‰éˆ• -->
        <div class="flex flex-col items-center text-slate-500 cursor-pointer group w-1/4" onclick="toggleOCRModal()">
            <div class="bg-gradient-to-tr from-sky-600 to-indigo-500 p-3.5 rounded-full -mt-10 border-4 border-[#0b1120] shadow-xl group-active:scale-95 transition-transform">
                <i data-lucide="plus" class="w-6 h-6 text-white"></i>
            </div>
            <span class="text-[10px] mt-1 font-medium text-slate-300">è¨˜å¸³</span>
        </div>
        
        <!-- è¨­å®šèˆ‡å‚™ä»½ -->
        <div class="flex flex-col items-center text-slate-500 hover:text-slate-300 cursor-pointer transition-colors w-1/4" onclick="toggleSettingsModal()">
            <i data-lucide="settings-2" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-medium tracking-wider">è¨­å®š</span>
        </div>
    </nav>

    <!-- è¨˜å¸³é›™è»Œä¸¦è¡Œ (OCR + CSV) å½ˆçª— -->
    <div id="ocr-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-6 opacity-0 transition-opacity duration-300">
        <div class="bg-slate-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 border-t sm:border border-slate-700 shadow-2xl transform translate-y-full sm:translate-y-0 transition-transform duration-300" id="ocr-modal-content">
            <div class="w-12 h-1.5 bg-slate-700 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 class="text-2xl font-bold mb-2 flex items-center gap-2">
                <i data-lucide="zap" class="text-yellow-400 fill-yellow-400"></i> æ¥µé€Ÿè¨˜å¸³
            </h3>
            <p class="text-sm text-slate-400 mb-6">è«‹é¸æ“‡æ‚¨åå¥½çš„åœ‹æ³°è­‰åˆ¸åŒ¯å…¥æ–¹å¼ï¼ŒAI å°‡è‡ªå‹•å°å¸³ä¸¦ç²¾ç®—ç¨…è²»ã€‚</p>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- é¸é … A: OCR æˆªåœ– -->
                <div class="border border-slate-600 rounded-2xl p-5 text-center bg-slate-800/50 hover:bg-slate-700 transition-colors cursor-pointer" onclick="simulateAIOCR()">
                    <i data-lucide="camera" class="w-8 h-8 text-sky-400 mx-auto mb-3"></i>
                    <p class="font-bold text-slate-200 text-sm">ğŸ“¸ æˆªåœ– AI è¾¨è­˜</p>
                    <p class="text-[10px] text-slate-500 mt-1">ç›¸æ©Ÿ / ç›¸ç°¿</p>
                </div>
                
                <!-- é¸é … B: CSV åŒ¯å…¥ -->
                <label class="border border-slate-600 rounded-2xl p-5 text-center bg-slate-800/50 hover:bg-slate-700 transition-colors cursor-pointer block">
                    <i data-lucide="file-spreadsheet" class="w-8 h-8 text-green-400 mx-auto mb-3"></i>
                    <p class="font-bold text-slate-200 text-sm">ğŸ“„ ä¸Šå‚³ CSV</p>
                    <p class="text-[10px] text-slate-500 mt-1">åœ‹æ³°å°å¸³å–®</p>
                    <input type="file" accept=".csv" class="hidden" onchange="simulateCSVImport(event)">
                </label>
            </div>
            
            <button onclick="toggleOCRModal()" class="w-full py-4 rounded-xl bg-slate-800 hover:bg-slate-700 text-white font-bold transition-colors">
                å–æ¶ˆ
            </button>
        </div>
    </div>

    <!-- å®‰å…¨è­·åŸæ²³å½ˆçª— -->
    <div id="safety-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-6 opacity-0 transition-opacity duration-200">
        <div class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-slate-700 shadow-2xl transform scale-95 transition-transform duration-200" id="safety-modal-content">
            <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                <i data-lucide="shield-check" class="text-indigo-400"></i> å®‰å…¨è­·åŸæ²³
            </h3>
            <p class="text-sm text-slate-400 mb-6">è¼¸å…¥æ‚¨çš„ç·Šæ€¥é å‚™é‡‘ï¼Œæ­¤è³‡é‡‘ä¸æœƒå—è‚¡å¸‚æ³¢å‹•å½±éŸ¿ï¼Œç‚ºæ‚¨çš„é€€ä¼‘è¨ˆç•«æ‰“åº•ã€‚</p>
            <input type="number" id="emergency-fund-input" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-4 mb-6 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-2xl font-bold number-font transition-all" placeholder="TWD">
            <div class="flex gap-3">
                <button onclick="toggleSafetyModal()" class="flex-1 py-3.5 rounded-xl bg-slate-700 text-white font-medium">å–æ¶ˆ</button>
                <button onclick="saveEmergencyFund()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 rounded-xl py-3.5 text-white font-bold shadow-lg shadow-indigo-900/50">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- é ˜æ¯ç´€éŒ„ (å¡ç‰‡åŒ–æ˜ç´°) å½ˆçª— -->
    <div id="dividend-record-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex flex-col justify-end sm:justify-center p-0 sm:p-4 opacity-0 transition-opacity duration-200">
        <div class="bg-slate-900 w-full sm:max-w-md h-[85vh] sm:h-[80vh] rounded-t-3xl sm:rounded-3xl p-6 border-t sm:border border-slate-700 shadow-2xl relative transform translate-y-full sm:translate-y-0 transition-transform duration-200 flex flex-col" id="dividend-record-content">
            <button onclick="closeDividendRecordModal()" class="absolute top-5 right-5 text-slate-400 hover:text-white transition-colors bg-slate-800 p-2 rounded-full">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h3 class="text-xl font-bold mb-1 flex items-center gap-2">
                <i data-lucide="book-open" class="text-indigo-400"></i> é ˜æ¯ç´€éŒ„
            </h3>
            <p class="text-sm text-slate-400 mb-4">æŒ‰å¹´ä»½çµ±è¨ˆèˆ‡å„æ¨™çš„é ˜æ¯æ˜ç´°</p>
            
            <div class="flex-1 overflow-y-auto no-scrollbar pb-4 space-y-4" id="dividend-history-list">
                <!-- ç”± JS å‹•æ…‹ç”Ÿæˆå¹´ä»½å¡ç‰‡ -->
            </div>
        </div>
    </div>

    <!-- è¨­å®šèˆ‡å‚™ä»½å½ˆçª— -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-6 opacity-0 transition-opacity duration-200">
        <div class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-slate-700 shadow-2xl relative transform scale-95 transition-transform duration-200" id="settings-modal-content">
            <button onclick="toggleSettingsModal()" class="absolute top-5 right-5 text-slate-400 hover:text-white transition-colors bg-slate-700/50 p-2 rounded-full">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                <i data-lucide="settings-2" class="text-sky-400"></i> è¨­å®šèˆ‡å‚™ä»½
            </h3>
            <p class="text-sm text-slate-400 mb-6">å°‡æ‚¨çš„è³‡ç”¢è³‡æ–™åŒ¯å‡ºç‚ºæª”æ¡ˆï¼Œæˆ–å¾èˆŠæª”æ¡ˆé‚„åŸï¼Œå¯¦ç¾è·¨è£ç½®å®‰å…¨æ‰‹å‹•åŒæ­¥ã€‚</p>
            
            <div class="space-y-4">
                <button onclick="exportData()" class="w-full flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-xl transition-colors border border-slate-600">
                    <i data-lucide="download" class="w-5 h-5 text-sky-400"></i> åŒ¯å‡ºå‚™ä»½æª” (.json)
                </button>
                <label class="w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl transition-colors cursor-pointer shadow-lg shadow-indigo-900/50">
                    <i data-lucide="upload" class="w-5 h-5 text-white"></i> é‚„åŸè³‡æ–™
                    <input type="file" accept=".json" class="hidden" onchange="importData(event)">
                </label>
            </div>
        </div>
    </div>

    <!-- JavaScript æ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script>
        const APP_VERSION = "1.5.2";
        const STORAGE_KEY = "lazy_wallet_data_v1.5.2";
        
        let isDividendAdjusted = false;
        let currentTab = 'tw';
        let sparklineCharts = {}; 
        
        const currentExchangeRate = 32.50; 

        // æ ¸å¿ƒï¼šä¹¾æ·¨çš„é è¨­ç©ºè³‡æ–™ (æ­¸é›¶ç‹€æ…‹)
        const emptyData = {
            tw: [],
            us: [],
            emergencyFund: 0,
            dividendHistory: []
        };

        // è®€å–è³‡æ–™ï¼šç¢ºä¿ LocalStorage æŒä¹…åŒ–ï¼Œè‹¥ç„¡å‰‡å¥—ç”¨ç©ºè³‡æ–™
        let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || emptyData;
        let livePulseInterval;

        function initApp() {
            lucide.createIcons();
            renderAssets();
            document.getElementById('emergency-fund-input').value = appData.emergencyFund || 0;
            
            const hasAssets = appData.tw.length > 0 || appData.us.length > 0;
            if (hasAssets) {
                startLivePulse(); 
            }

            // åˆå§‹åŒ–æ™‚ç¢ºä¿å­˜æª”
            saveToLocalStorage();
            
            // æ¨æ’­é‚è¼¯
            if (!hasAssets) {
                setTimeout(showNotification, 1500);
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        function showNotification() {
            const toast = document.getElementById('toast-container');
            toast.classList.remove('hidden');
            toast.classList.add('toast-notification');
        }

        function switchTab(tab) {
            currentTab = tab;
            const tabTw = document.getElementById('tab-tw');
            const tabUs = document.getElementById('tab-us');
            
            if (tab === 'tw') {
                tabTw.className = 'px-5 py-2 rounded-lg text-sm font-bold bg-slate-700 shadow text-white transition-all flex items-center gap-1';
                tabUs.className = 'px-5 py-2 rounded-lg text-sm font-bold text-slate-400 transition-all flex items-center gap-1 hover:bg-slate-800';
            } else {
                tabUs.className = 'px-5 py-2 rounded-lg text-sm font-bold bg-slate-700 shadow text-white transition-all flex items-center gap-1';
                tabTw.className = 'px-5 py-2 rounded-lg text-sm font-bold text-slate-400 transition-all flex items-center gap-1 hover:bg-slate-800';
            }
            renderAssets();
        }

        function toggleDividendAdjusted() {
            isDividendAdjusted = !isDividendAdjusted;
            const circle = document.getElementById('toggle-circle');
            const bg = document.getElementById('dividend-toggle');
            
            if (isDividendAdjusted) {
                circle.style.transform = 'translateX(16px)';
                bg.classList.replace('bg-slate-600', 'bg-sky-500');
            } else {
                circle.style.transform = 'translateX(4px)';
                bg.classList.replace('bg-sky-500', 'bg-slate-600');
            }
            renderAssets();
        }

        function renderAssets() {
            const listContainer = document.getElementById('stock-list');
            listContainer.innerHTML = '';
            
            // æ¸…é™¤èˆŠçš„ Chart å¯¦ä¾‹é˜²æ­¢å…§å­˜æ´©æ¼
            Object.values(sparklineCharts).forEach(chart => chart.destroy());
            sparklineCharts = {};
            
            const stocks = appData[currentTab] || [];
            let totalMarketValueTWD = 0;
            let todayPnLTWD = 0;

            const allTWValue = (appData.tw || []).reduce((sum, s) => sum + (s.price * s.shares), 0);
            const allUSValue = (appData.us || []).reduce((sum, s) => sum + (s.price * s.shares * currentExchangeRate), 0);
            totalMarketValueTWD = allTWValue + allUSValue;

            if (stocks.length === 0) {
                listContainer.innerHTML = `
                    <div class="col-span-1 sm:col-span-2 text-center py-12 text-slate-500">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p>ç›®å‰æ²’æœ‰${currentTab === 'tw' ? 'å°è‚¡' : 'ç¾è‚¡'}è³‡ç”¢</p>
                        <p class="text-xs mt-1 opacity-70">è«‹é€éä¸‹æ–¹ã€Œè¨˜å¸³ã€æ–°å¢æ‚¨çš„ç¬¬ä¸€ç­†äº¤æ˜“</p>
                    </div>
                `;
            } else {
                stocks.forEach(stock => {
                    const currentPrice = stock.price;
                    const marketValue = currentTab === 'tw' ? (stock.price * stock.shares) : (stock.price * stock.shares * currentExchangeRate);
                    const todayJump = stock.change * stock.shares * (currentTab === 'tw' ? 1 : currentExchangeRate);
                    todayPnLTWD += todayJump;
                    
                    let costPerShare = stock.cost;
                    if (isDividendAdjusted) costPerShare = stock.cost - (stock.dividend || 0);

                    let pnlPercent, profit, usDetailsHTML = '';
                    
                    if (currentTab === 'us') {
                        const originalCostTWD = costPerShare * stock.shares * (stock.costExchangeRate || currentExchangeRate);
                        profit = marketValue - originalCostTWD;
                        pnlPercent = originalCostTWD > 0 ? (profit / originalCostTWD * 100).toFixed(2) : 0;
                        
                        const stockReturn = costPerShare > 0 ? (stock.price - costPerShare) / costPerShare * 100 : 0;
                        const fxReturn = stock.costExchangeRate ? (currentExchangeRate - stock.costExchangeRate) / stock.costExchangeRate * 100 : 0;
                        
                        usDetailsHTML = `
                            <div class="col-span-2 mt-2 pt-2 border-t border-slate-700/50 flex justify-between text-[10px] font-mono">
                                <span class="text-slate-400">è‚¡åƒ¹ç¸¾æ•ˆ: <span class="${stockReturn >= 0 ? 'text-red-400' : 'text-green-400'}">${stockReturn > 0 ? '+' : ''}${stockReturn.toFixed(1)}%</span></span>
                                <span class="text-slate-400">åŒ¯ç‡æç›Š: <span class="${fxReturn >= 0 ? 'text-red-400' : 'text-green-400'}">${fxReturn > 0 ? '+' : ''}${fxReturn.toFixed(1)}%</span></span>
                            </div>
                        `;
                    } else {
                        profit = (stock.price - costPerShare) * stock.shares;
                        const costBase = costPerShare * stock.shares;
                        pnlPercent = costBase > 0 ? (profit / costBase * 100).toFixed(2) : 0;
                    }

                    const colorClass = profit >= 0 ? 'up-color' : 'down-color';
                    const sideColor = profit >= 0 ? 'bg-red-500' : 'bg-green-500';

                    const originalTotalCost = stock.cost * stock.shares;
                    const totalDividend = (stock.dividend || 0) * stock.shares;
                    const adjustedTotalCost = originalTotalCost - totalDividend;

                    const card = document.createElement('div');
                    card.className = 'stock-card bg-slate-800/60 rounded-2xl p-4 border border-slate-700/60 shadow-lg relative overflow-hidden backdrop-blur-sm';
                    
                    card.innerHTML = `
                        <div class="absolute left-0 top-0 bottom-0 w-1 ${sideColor} opacity-80"></div>
                        <div class="flex justify-between items-start mb-3 pl-1">
                            <div>
                                <h3 class="font-bold text-lg text-slate-100 leading-tight">${stock.name}</h3>
                                <p class="text-[11px] text-slate-500 font-mono mt-0.5">${stock.id}</p>
                            </div>
                            <div class="text-right flex flex-col items-end">
                                <p class="text-xl font-bold number-font text-slate-100">${currentTab === 'us' ? '$' : ''}${currentPrice}</p>
                                <div class="w-16 h-5 mt-1 opacity-80"><canvas id="sparkline-${stock.id}"></canvas></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 bg-slate-900/40 rounded-xl p-3 pl-4 border border-slate-800/50 mb-3">
                            <div>
                                <p class="text-[10px] text-slate-500 mb-0.5">ç¸½å¸‚å€¼ (TWD)</p>
                                <p class="text-sm font-bold number-font">$${Math.round(marketValue).toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-500 mb-0.5">${isDividendAdjusted ? '<span class="text-sky-400">å«æ¯</span>å ±é…¬' : 'å¸³é¢å ±é…¬'}</p>
                                <p class="text-sm font-bold ${colorClass} number-font">${profit >= 0 ? '+' : ''}${pnlPercent}%</p>
                            </div>
                            ${usDetailsHTML}
                        </div>

                        <div class="bg-slate-900/60 p-2.5 rounded-lg text-[10px] text-slate-400 font-mono space-y-1 border border-slate-800">
                             <div class="flex justify-between">
                                <span>æœªå«æ¯ç¸½æœ¬é‡‘</span><span>$${Math.round(currentTab === 'tw'? originalTotalCost : originalTotalCost*(stock.costExchangeRate||currentExchangeRate)).toLocaleString()}</span>
                             </div>
                             <div class="flex justify-between">
                                <span>ç´¯è¨ˆå·²é ˜è‚¡æ¯</span><span class="text-sky-400">-$${Math.round(currentTab === 'tw'? totalDividend : totalDividend*(stock.costExchangeRate||currentExchangeRate)).toLocaleString()}</span>
                             </div>
                             <div class="flex justify-between border-t border-slate-700/50 mt-1 pt-1.5">
                                <span class="font-bold text-slate-300">å«æ¯ç¸½æœ¬é‡‘</span><span class="font-bold text-white">$${Math.round(currentTab === 'tw'? adjustedTotalCost : adjustedTotalCost*(stock.costExchangeRate||currentExchangeRate)).toLocaleString()}</span>
                             </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                    
                    if(stock.history && stock.history.length > 0) {
                        renderSparkline(`sparkline-${stock.id}`, stock.history);
                    }
                });
            }
            
            lucide.createIcons();
            updateDashboardMetrics(totalMarketValueTWD, todayPnLTWD);
        }
        
        function updateDashboardMetrics(totalValue, todayPnL) {
            document.getElementById('total-assets').innerText = `$${Math.round(totalValue).toLocaleString()}`;
            
            const pnlValEl = document.getElementById('today-pnl-value');
            const pnlPctEl = document.getElementById('total-pnl');
            const pnlBgEl = document.getElementById('today-icon-bg');
            const pnlIconEl = document.getElementById('today-icon');

            if (totalValue === 0) {
                pnlValEl.innerText = '+$0';
                pnlPctEl.innerText = '0.00%';
                pnlValEl.className = 'text-xl font-bold text-slate-400 number-font';
                pnlPctEl.className = 'text-sm font-medium text-slate-400 bg-slate-500/10 px-1.5 py-0.5 rounded number-font';
                pnlBgEl.className = 'p-2 bg-slate-500/10 rounded-xl';
                pnlIconEl.className = 'w-5 h-5 text-slate-400';
            } else {
                pnlValEl.innerText = `${todayPnL >= 0 ? '+' : ''}$${Math.round(todayPnL).toLocaleString()}`;
                const totalPercent = (todayPnL / totalValue * 100).toFixed(2);
                pnlPctEl.innerText = `${totalPercent >= 0 ? '+' : ''}${totalPercent}%`;
                
                if(todayPnL < 0) {
                    pnlValEl.className = 'text-xl font-bold down-color number-font';
                    pnlPctEl.className = 'text-sm font-medium down-color bg-green-500/10 px-1.5 py-0.5 rounded number-font';
                    pnlBgEl.className = 'p-2 bg-green-500/10 rounded-xl';
                    pnlIconEl.className = 'w-5 h-5 down-color';
                } else {
                    pnlValEl.className = 'text-xl font-bold up-color number-font';
                    pnlPctEl.className = 'text-sm font-medium up-color bg-red-500/10 px-1.5 py-0.5 rounded number-font';
                    pnlBgEl.className = 'p-2 bg-red-500/10 rounded-xl';
                    pnlIconEl.className = 'w-5 h-5 up-color';
                }
                
                startLivePulse();
            }
        }
        
        function renderSparkline(canvasId, dataPoints) {
            const canvas = document.getElementById(canvasId);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const isUp = dataPoints[dataPoints.length - 1] >= dataPoints[0];
            const lineColor = isUp ? '#ef4444' : '#22c55e'; 
            
            sparklineCharts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1', '2', '3', '4', '5', '6', '7'],
                    datasets: [{
                        data: dataPoints,
                        borderColor: lineColor,
                        borderWidth: 1.5,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } },
                    layout: { padding: 0 }
                }
            });
        }

        function startLivePulse() {
            clearInterval(livePulseInterval);
            
            const hasAssets = appData.tw.length > 0 || appData.us.length > 0;
            if (!hasAssets) return; 

            livePulseInterval = setInterval(() => {
                const isUp = Math.random() > 0.5;
                const totalAssetsEl = document.getElementById('total-assets');
                let currentVal = parseInt(totalAssetsEl.innerText.replace(/[$,]/g, ''));
                if(isNaN(currentVal) || currentVal === 0) return;

                let change = Math.floor(Math.random() * 500);
                if (isUp) currentVal += change; else currentVal -= change;
                
                totalAssetsEl.classList.remove('live-update');
                void totalAssetsEl.offsetWidth; 
                totalAssetsEl.classList.add('live-update');
                
                totalAssetsEl.innerText = `$${currentVal.toLocaleString()}`;
            }, 3500);
        }

        // ---------- UI å½ˆçª—æ§åˆ¶é‚è¼¯ ----------
        function toggleModal(modalId, contentId) {
            const modal = document.getElementById(modalId);
            const content = document.getElementById(contentId);
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    if(window.innerWidth < 640 && content.classList.contains('translate-y-full')) {
                        content.classList.remove('translate-y-full'); 
                    } else if (content.classList.contains('scale-95')) {
                        content.classList.remove('scale-95');
                    }
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                if(window.innerWidth < 640 && !content.classList.contains('translate-y-full') && content.className.includes('translate-y-')) {
                     content.classList.add('translate-y-full');
                } else if (!content.className.includes('translate-y-')) {
                     content.classList.add('scale-95');
                }
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function toggleOCRModal() {
            toggleModal('ocr-modal', 'ocr-modal-content');
        }

        function toggleSafetyModal() {
            toggleModal('safety-modal', 'safety-modal-content');
        }
        
        function toggleSettingsModal() {
            toggleModal('settings-modal', 'settings-modal-content');
        }

        function showDividendRecordModal() {
            toggleModal('dividend-record-modal', 'dividend-record-content');
            renderDividendHistory();
        }

        function closeDividendRecordModal() {
            toggleModal('dividend-record-modal', 'dividend-record-content');
        }

        // ---------- æ¥­å‹™æ“ä½œé‚è¼¯ ----------
        function simulateAIOCR() {
            alert("âœ¨ è¾¨è­˜æˆåŠŸï¼\n\nè²·å…¥ï¼š00929 å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯\nè‚¡æ•¸ï¼š5,000è‚¡\nå–®åƒ¹ï¼š19.50\n\nè³‡æ–™å·²å…¥åº«ï¼Œç¾åœ¨å³ä½¿é‡æ–°æ•´ç†ç¶²é ï¼Œè³‡æ–™ä¹Ÿä¸æœƒæ¶ˆå¤±ï¼");
            const newStock = { 
                id: '00929', name: 'å¾©è¯ç§‘æŠ€å„ªæ¯', price: 19.5, shares: 5000, 
                cost: 19.5, dividend: 0, change: 0.1, 
                history:[19.3, 19.4, 19.4, 19.5, 19.4, 19.5, 19.5] 
            };
            appData.tw.push(newStock);
            saveToLocalStorage();
            toggleOCRModal();
            renderAssets();
        }
        
        function simulateCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            alert(`âœ… æˆåŠŸè®€å– CSV æª”æ¡ˆï¼š${file.name}\n\nç³»çµ±å·²è‡ªå‹•æŠ“å–æ¬„ä½ä¸¦æ‰£é™¤æ‰‹çºŒè²»ã€‚å·²åŒ¯å…¥ï¼š0050 å…ƒå¤§å°ç£50`);
            const newStock = { 
                id: '0050', name: 'å…ƒå¤§å°ç£50', price: 165, shares: 1000, 
                cost: 160, dividend: 0, change: 1.5, 
                history:[160, 161, 163, 162, 164, 163, 165] 
            };
            appData.tw.push(newStock);
            saveToLocalStorage();
            toggleOCRModal();
            renderAssets();
            event.target.value = ''; 
        }

        function saveEmergencyFund() {
            const val = document.getElementById('emergency-fund-input').value;
            appData.emergencyFund = parseInt(val) || 0;
            saveToLocalStorage();
            toggleSafetyModal();
            renderAssets();
        }
        
        function renderDividendHistory() {
            const listContainer = document.getElementById('dividend-history-list');
            listContainer.innerHTML = '';
            
            if (!appData.dividendHistory || appData.dividendHistory.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-slate-500">
                        <i data-lucide="book-dashed" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p>ç›®å‰æ²’æœ‰é ˜æ¯ç´€éŒ„</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            appData.dividendHistory.forEach(yearData => {
                let itemsHTML = yearData.items.map(item => `
                    <div class="flex justify-between items-center py-2 border-b border-slate-700/50 last:border-0">
                        <div class="flex items-center gap-2">
                            <div class="w-1.5 h-1.5 rounded-full bg-sky-400"></div>
                            <span class="text-sm text-slate-300">${item.name}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-bold number-font text-white">$${item.amount.toLocaleString()}</span>
                            <span class="block text-[10px] text-slate-500 mt-0.5 bg-slate-800 px-1.5 py-0.5 rounded border border-slate-700 inline-block">#${item.tag}</span>
                        </div>
                    </div>
                `).join('');
                
                const card = document.createElement('div');
                card.className = 'bg-slate-800 rounded-2xl p-5 border border-slate-700 shadow-lg';
                card.innerHTML = `
                    <div class="flex justify-between items-end mb-4 pb-4 border-b border-slate-700">
                        <div>
                            <span class="text-xl font-bold text-white number-font">${yearData.year}</span>
                            <span class="text-xs text-slate-400 ml-1">å¹´åº¦</span>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-slate-400 block mb-0.5">ç¸½è¨ˆé ˜æ¯</span>
                            <span class="text-2xl font-bold text-sky-400 number-font">$${yearData.total.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        ${itemsHTML}
                    </div>
                `;
                listContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        // ---------- å‚™ä»½é‚„åŸé‚è¼¯ ----------
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const downloadAnchorNode = document.createElement('a');
            const dateStr = new Date().toISOString().slice(0, 10);
            
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `lazy_wallet_backup_${dateStr}.json`);
            
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && importedData.tw && importedData.us) {
                        appData = importedData;
                        saveToLocalStorage();
                        
                        document.getElementById('emergency-fund-input').value = appData.emergencyFund || 0;
                        renderAssets();
                        toggleSettingsModal();
                        
                        alert("âœ… å‚™ä»½è³‡æ–™é‚„åŸæˆåŠŸï¼è³‡ç”¢ç‹€æ…‹å·²æ›´æ–°ã€‚");
                    } else {
                        alert("âŒ æª”æ¡ˆæ ¼å¼ä¸ç¬¦ï¼Œè«‹ç¢ºèªé€™æ˜¯å¦ç‚ºé€€ä¼‘æ‡¶éŒ¢åŒ…çš„å‚™ä»½æª”ã€‚");
                    }
                } catch (error) {
                    alert("âŒ è®€å–æª”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ææ¯€ã€‚");
                }
                event.target.value = ''; 
            };
            reader.readAsText(file);
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        window.onload = initApp;
    </script>
</body>
</html>
