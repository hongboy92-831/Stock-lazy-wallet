<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stockify å°ˆæ¥­ç‰ˆ v4.2.8</title>
    
    <!-- 1. å¼•å…¥å¿…è¦çš„å‡½å¼åº« (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. å¼•å…¥ Firebase SDK (Compat ç‰ˆ) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', "Microsoft JhengHei", sans-serif; overflow: hidden; background-color: #f3f4f6; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent; bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }
        .app-container { height: 100vh; width: 100%; max-width: 640px; margin: 0 auto; position: relative; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase è¨­å®š (æ”¯æ´æœ¬åœ°å„²å­˜è‡ªè¨‚è¨­å®š) ---
        const localFbConfigStr = localStorage.getItem('stockify_firebase_config');
        let parsedLocalFbConfig = null;
        try {
            if (localFbConfigStr) parsedLocalFbConfig = JSON.parse(localFbConfigStr);
        } catch(e) { console.warn("Failed to parse local firebase config"); }

        const firebaseConfig = parsedLocalFbConfig || (window.__firebase_config ? JSON.parse(window.__firebase_config) : {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        });

        // å®‰å…¨é˜²è­·ï¼šæª¢æŸ¥æ˜¯å¦æœ‰å¡«å¯« API Key (æ±ºå®šä½¿ç”¨å–®æ©Ÿæˆ–é›²ç«¯)
        const isFirebaseConfigured = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey.trim() !== "";
        
        let auth = null;
        let db = null;

        if (isFirebaseConfigured) {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
        }

        const APP_VERSION = 'v4.2.8';
        const TOKEN_KEY = 'stockify_token';
        
        // é è¨­ FinMind Token
        const MY_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNi0wMy0wMSAwMjowOTo0OCIsInVzZXJfaWQiOiJob25nYm95IiwiZW1haWwiOiJob25nYm95OTJAZ21haWwuY29tIiwiaXAiOiI2MS4yMjAuOTMuNzQifQ.Mk4GPZsGRLM79QvxVHIcRXE5y_FThk9uMCsoJfmQCYc";

        const STORAGE_KEY = 'stockify_v4_txs';
        const MASTER_KEY = 'stockify_v4_master';

        // --- SVG åœ–ç¤ºçµ„ä»¶ ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                PieChart: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z"/>,
                History: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-4v4h4"/>,
                Plus: <path d="M12 5v14M5 12h14"/>,
                Coins: <React.Fragment><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18.1"/></React.Fragment>,
                Refresh: <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>,
                Settings: <React.Fragment><path d="M12.22 2h-.44a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2a2 2 0 0 1 2 2a2 2 0 0 0 2 2a2 2 0 0 1 2 2a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0 2-2v-.44a2 2 0 0 0-2-2a2 2 0 0 1-2-2a2 2 0 0 0-2-2a2 2 0 0 1-2-2a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></React.Fragment>,
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                ArrowUpDown: <path d="m21 16-4 4-4-4M21 20V12M3 8l4-4 4 4M3 4v8"/>,
                ToggleLeft: <React.Fragment><rect width="20" height="12" x="2" y="6" rx="6"/><circle cx="8" cy="12" r="2"/></React.Fragment>,
                ToggleRight: <React.Fragment><rect width="20" height="12" x="2" y="6" rx="6" fill="#3B82F6"/><circle cx="16" cy="12" r="2" fill="white"/></React.Fragment>,
                Trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>,
                Calendar: <React.Fragment><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></React.Fragment>,
                Key: <React.Fragment><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3v-3.5L15.5 7.5z"/></React.Fragment>,
                Download: <React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5m-5 5V3"/></React.Fragment>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-4v4h4"/>,
                AlertCircle: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></React.Fragment>,
                Loader2: <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>,
                CheckCircle2: <React.Fragment><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></React.Fragment>,
                Upload: <React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5-5-5-5 5m5-5v12"/></React.Fragment>,
                Cloud: <React.Fragment><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></React.Fragment>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" stroke="red" />}
                </svg>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [isCloudLoading, setIsCloudLoading] = useState(true);
            const [view, setView] = useState('holding'); 
            const [transactions, setTransactions] = useState([]);
            const [stockMaster, setStockMaster] = useState({}); 
            const [marketData, setMarketData] = useState({}); 
            const [apiToken, setApiToken] = useState(''); 
            const [fbConfigInput, setFbConfigInput] = useState(localFbConfigStr || ''); 
            const [isUpdating, setIsUpdating] = useState(false);
            const [isMasked, setIsMasked] = useState(false);
            const [showWithDividend, setShowWithDividend] = useState(true); 
            const [selectedStockId, setSelectedStockId] = useState(null);
            const [pendingDeleteId, setPendingDeleteId] = useState(null);
            const [recordSortOrder, setRecordSortOrder] = useState('desc'); 

            const [formCode, setFormCode] = useState('');
            const [formDate, setFormDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState('è²·é€²');
            const [formTotalAmount, setFormTotalAmount] = useState(''); 
            const [formPrice, setFormPrice] = useState('');     
            const [formShares, setFormShares] = useState('');   
            const [formFee, setFormFee] = useState('');         
            const [isSearchingName, setIsSearchingName] = useState(false);

            // --- 1. åˆå§‹åŒ– ---
            useEffect(() => {
                const savedToken = localStorage.getItem(TOKEN_KEY);
                setApiToken(savedToken || MY_TOKEN);

                if (!isFirebaseConfigured || !auth) {
                    const savedTxs = localStorage.getItem(STORAGE_KEY);
                    const savedMaster = localStorage.getItem(MASTER_KEY);
                    if (savedTxs) setTransactions(JSON.parse(savedTxs));
                    if (savedMaster) setStockMaster(JSON.parse(savedMaster));
                    setIsCloudLoading(false);
                    return;
                }

                const unsubscribe = auth.onAuthStateChanged(async (currUser) => {
                    if (!currUser) {
                        try { await auth.signInAnonymously(); } catch (e) { console.error(e); }
                    } else {
                        setUser(currUser);
                        setIsCloudLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isFirebaseConfigured || !user || !db) return;
                const appIdStr = window.__app_id || 'stockify-v4';
                const txRef = db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('transactions');
                const unsub = txRef.onSnapshot(snap => {
                    setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                const masterRef = db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('settings').doc('master');
                const unsubM = masterRef.onSnapshot(doc => {
                    if (doc.exists) setStockMaster(doc.data());
                });
                return () => { unsub(); unsubM(); };
            }, [user]);

            // --- 2. API æŸ¥è©¢ ---
            const syncMarketData = async () => {
                if (isUpdating || !apiToken) return;
                const codes = [...new Set(transactions.map(t => t.stockId))];
                if (codes.length === 0) return;
                setIsUpdating(true);
                try {
                    const newMarket = { ...marketData };
                    const dateLimit = new Date(); dateLimit.setDate(dateLimit.getDate() - 7);
                    const dateStr = dateLimit.toISOString().split('T')[0];
                    for (const code of codes) {
                        const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${code}&start_date=${dateStr}&token=${apiToken}`;
                        const resp = await fetch(url);
                        const json = await resp.json();
                        if (json.msg === 'success' && json.data && json.data.length > 0) {
                            const latest = json.data[json.data.length - 1];
                            const prev = json.data.length > 1 ? json.data[json.data.length - 2] : latest;
                            newMarket[code] = { p: latest.close, c: parseFloat((latest.close - prev.close).toFixed(2)) };
                        }
                    }
                    setMarketData(newMarket);
                } catch (e) { console.error(e); } 
                finally { setIsUpdating(false); }
            };

            const fetchStockInfo = async (code) => {
                if (!apiToken) return;
                setIsSearchingName(true);
                try {
                    const resp = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInfo&data_id=${code}&token=${apiToken}`);
                    const json = await resp.json();
                    if (json.msg === 'success' && json.data && json.data.length > 0) {
                        const info = json.data[0];
                        const newM = { ...stockMaster, [code]: { n: info.stock_name, t: code.endsWith('B') ? 'BondETF' : (code.startsWith('00') ? 'StockETF' : 'Stock') } };
                        setStockMaster(newM);
                        
                        if (isFirebaseConfigured && user && db) {
                            const appIdStr = window.__app_id || 'stockify-v4';
                            await db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('settings').doc('master').set(newM);
                        } else {
                            localStorage.setItem(MASTER_KEY, JSON.stringify(newM));
                        }
                    }
                } catch (e) { console.error(e); } 
                finally { setIsSearchingName(false); }
            };

            useEffect(() => {
                const code = formCode.toUpperCase();
                if (code.length < 2 || stockMaster[code]) return;
                const t = setTimeout(() => fetchStockInfo(code), 600);
                return () => clearTimeout(t);
            }, [formCode]);

            const stats = useMemo(() => {
                const inv = {};
                [...transactions].sort((a,b)=>a.timestamp - b.timestamp).forEach(tx => {
                    const id = tx.stockId;
                    if (!inv[id]) inv[id] = { sh: 0, cost: 0, div: 0, realized: 0, n: tx.stockName, history: [] };
                    inv[id].history.push(tx);
                    if (tx.type === 'è²·é€²') { inv[id].sh += tx.shares; inv[id].cost += Math.abs(tx.total); }
                    else if (tx.type === 'è³£å‡º' && inv[id].sh > 0) {
                        const avg = inv[id].cost / inv[id].sh;
                        const soldCost = tx.shares * avg;
                        inv[id].realized += (tx.total - soldCost);
                        inv[id].cost -= soldCost; inv[id].sh -= tx.shares;
                    }
                    else if (tx.type === 'é…æ¯') { inv[id].div += Math.abs(tx.total); }
                });
                let mv = 0, remC = 0, dp = 0, td = 0;
                Object.entries(inv).forEach(([id, d]) => {
                    const m = marketData[id] || { p: 0, c: 0 };
                    mv += d.sh * m.p; remC += d.cost; dp += d.sh * m.c; td += d.div;
                });
                const unrealized = mv - remC;
                const profit = showWithDividend ? unrealized + td : unrealized;
                return { profit, pct: remC > 0 ? (profit/remC*100) : 0, mv, remC, dp, td, inv };
            }, [transactions, marketData, showWithDividend]);

            const calc = useMemo(() => {
                if (activeTab === 'é…æ¯') {
                    if (formTotalAmount) return { total: parseFloat(formTotalAmount), fee: 0 };
                    return { total: (parseFloat(formPrice)||0) * (parseInt(formShares)||0) - (parseFloat(formFee)||0), fee: parseFloat(formFee)||0 };
                }
                const amt = (parseFloat(formPrice)||0) * (parseInt(formShares)||0);
                let f = Math.floor(amt * 0.001425 * 0.6); if (f < 20 && amt > 0) f = 20;
                let tr = 0.003; if (formCode.endsWith('B')) tr = 0; else if (formCode.startsWith('00')) tr = 0.001;
                const tax = activeTab === 'è³£å‡º' ? Math.floor(amt * tr) : 0;
                return { total: activeTab === 'è²·é€²' ? -(amt + f) : (amt - f - tax), fee: f + tax };
            }, [formPrice, formShares, formFee, formTotalAmount, activeTab, formCode]);

            // --- 3. å‹•ä½œè™•ç† ---
            const saveTx = async (stay) => {
                if (!formCode || (activeTab !== 'é…æ¯' && (!formPrice || !formShares))) return;
                const code = formCode.toUpperCase();
                const newTx = {
                    stockId: code, 
                    stockName: stockMaster[code]?.n || `æ¨™çš„ ${code}`,
                    type: activeTab, 
                    price: parseFloat(formPrice)||0, 
                    shares: parseInt(formShares)||0,
                    total: calc.total, 
                    date: formDate.replace(/-/g, '/'), 
                    timestamp: Date.now()
                };

                if (isFirebaseConfigured && user && db) {
                    try {
                        const appIdStr = window.__app_id || 'stockify-v4';
                        await db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('transactions').add(newTx);
                    } catch (e) { console.error(e); }
                } else {
                    newTx.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                    const updated = [newTx, ...transactions];
                    setTransactions(updated);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                }

                setFormPrice(''); setFormShares(''); setFormFee(''); setFormTotalAmount('');
                if (!stay) { setFormCode(''); setView('holding'); }
            };

            const confirmDelete = async () => {
                if (isFirebaseConfigured && user && db && pendingDeleteId) {
                    try {
                        const appIdStr = window.__app_id || 'stockify-v4';
                        await db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('transactions').doc(pendingDeleteId).delete();
                    } catch (e) { console.error(e); }
                } else {
                    const updated = transactions.filter(t => t.id !== pendingDeleteId);
                    setTransactions(updated);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                }
                
                setPendingDeleteId(null);
                const remainingForThisStock = transactions.filter(t => t.stockId === selectedStockId && t.id !== pendingDeleteId);
                if (view === 'detail' && remainingForThisStock.length === 0) setView('holding');
            };

            const handleSaveToken = (token) => { 
                setApiToken(token); 
                localStorage.setItem(TOKEN_KEY, token); 
            };
            
            // ğŸ¯ æ™ºæ…§è§£æå™¨ï¼šå…è¨±è²¼ä¸Šå¸¶æœ‰è®Šæ•¸å®£å‘Šèˆ‡åˆ†è™Ÿçš„ JS ç‰©ä»¶
            const handleSaveFbConfig = () => {
                let input = fbConfigInput.trim();
                if(!input) return;
                
                try {
                    // ç§»é™¤å¯èƒ½è¤‡è£½åˆ°çš„ "const firebaseConfig = " ç­‰å®£å‘Šæ–‡å­—
                    if (input.includes('=')) {
                        input = input.substring(input.indexOf('=') + 1).trim();
                    }
                    // ç§»é™¤çµå°¾çš„åˆ†è™Ÿ
                    if (input.endsWith(';')) {
                        input = input.slice(0, -1).trim();
                    }
                    
                    // ä½¿ç”¨å®‰å…¨è©•ä¼°å°‡ JS ç‰©ä»¶è½‰ç‚ºæ¨™æº– JSON ç‰©ä»¶
                    const parsed = new Function("return " + input)();
                    
                    if (!parsed || !parsed.apiKey) throw new Error("æ‰¾ä¸åˆ° apiKeyï¼Œè«‹ç¢ºèªå…§å®¹å®Œæ•´");
                    
                    // å¼·åˆ¶ä»¥æ¨™æº– JSON æ ¼å¼å­˜å…¥ LocalStorage
                    localStorage.setItem('stockify_firebase_config', JSON.stringify(parsed));
                    alert("ğŸ‰ Firebase é›²ç«¯è¨­å®šå·²æˆåŠŸå¥—ç”¨ï¼\nç³»çµ±å°‡ç‚ºæ‚¨é‡æ–°è¼‰å…¥é é¢é€£ç·šé›²ç«¯ã€‚");
                    window.location.reload();
                } catch(e) {
                    alert("âŒ è§£æå¤±æ•—ï¼\nè«‹ç›´æ¥å¾ Firebase æ§åˆ¶å°è¤‡è£½åŒ…å«å¤§æ‹¬è™Ÿ { ... } çš„å®Œæ•´å€å¡Šè²¼ä¸Šã€‚\n\nè©³ç´°éŒ¯èª¤: " + e.message);
                }
            };

            const handleClearFbConfig = () => {
                localStorage.removeItem('stockify_firebase_config');
                alert("å·²åˆ‡æ›å›å–®æ©Ÿæ¨¡å¼ï¼\nç³»çµ±å°‡é‡æ–°è¼‰å…¥é é¢ã€‚");
                window.location.reload();
            };

            const handleImport = (e) => {
                const reader = new FileReader();
                reader.onload = ev => { 
                    try {
                        const importedData = JSON.parse(ev.target.result);
                        if(Array.isArray(importedData)) {
                            setTransactions(importedData);
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
                            setView('holding');
                            alert("è³‡æ–™åŒ¯å…¥æˆåŠŸï¼");
                        }
                    } catch (err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
                };
                if(e.target.files[0]) reader.readAsText(e.target.files[0]);
            };

            const Mask = ({ val }) => isMasked ? "****" : <span className={val >= 0 ? 'text-red-500' : 'text-green-600'}>{val.toLocaleString(undefined, {maximumFractionDigits:0})}</span>;

            if (isCloudLoading) return <div className="h-screen flex flex-col items-center justify-center bg-white"><div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div><p className="font-black text-blue-500 italic uppercase">Initializing...</p></div>;

            return (
                <div className="app-container overflow-hidden bg-white">
                    <div className="flex-1 overflow-hidden relative bg-white">
                        
                        {/* é¦–é  */}
                        {view === 'holding' && (
                            <div className="flex flex-col h-full animate-in fade-in">
                                <div className="p-5 flex justify-between items-center border-b border-gray-50 bg-white sticky top-0 z-20">
                                    <div className="flex flex-col">
                                        <h1 className="text-3xl font-black italic text-gray-800 tracking-tighter">St<span className="text-blue-600">o</span>ckify</h1>
                                        <p className="text-[10px] text-gray-400 font-bold ml-1 uppercase tracking-widest">{APP_VERSION} â€¢ {isFirebaseConfigured ? <span className="text-blue-500">Cloud Mode</span> : 'Local Mode'}</p>
                                    </div>
                                    <div className="flex space-x-2">
                                        <button onClick={() => setIsMasked(!isMasked)} className="p-2 text-gray-300 active:scale-95"><Icon name="RotateCcw" size={24}/></button>
                                        <button onClick={() => setView('settings')} className="p-2 text-gray-400 active:scale-95"><Icon name="Settings" size={24}/></button>
                                    </div>
                                </div>
                                <div className="px-6 py-6">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-gray-400 font-bold text-xs uppercase tracking-widest">{showWithDividend ? 'ç´¯ç©æç›Š (å«æ¯)' : 'æŒè‚¡æœªå¯¦ç¾æç›Š'}</span>
                                        <button onClick={() => setShowWithDividend(!showWithDividend)} className={`px-3 py-1 rounded-xl border text-xs font-black flex items-center space-x-1 ${showWithDividend ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-gray-50 text-gray-400 border-gray-100'}`}>
                                            {showWithDividend ? <Icon name="ToggleRight" size={20}/> : <Icon name="ToggleLeft" size={20}/>} <span>{showWithDividend ? 'å«æ¯' : 'é™¤æ¯'}</span>
                                        </button>
                                    </div>
                                    <div className="flex items-baseline space-x-3">
                                        <span className="text-5xl font-black tabular-nums tracking-tighter"><Mask val={stats.profit} /></span>
                                        <span className={`text-xl font-black ${stats.profit >= 0 ? 'text-red-500' : 'text-green-600'}`}>{isMasked ? '***' : `${stats.profit >= 0 ? '+' : ''}${stats.pct.toFixed(2)}%`}</span>
                                    </div>
                                </div>
                                <div className="grid grid-cols-3 px-6 py-6 border-y border-gray-100 bg-gray-50/40">
                                    <div className="text-center"><p className="text-gray-400 font-black text-[10px] uppercase">ä»Šæ—¥æç›Š</p><p className="font-black text-xl"><Mask val={stats.dp} /></p></div>
                                    <div className="text-center border-x border-gray-200"><p className="text-gray-400 font-black text-[10px] uppercase tracking-tighter">æŒè‚¡å¸‚å€¼</p><p className="font-black text-xl text-gray-800">{isMasked ? '****' : stats.mv.toLocaleString()}</p></div>
                                    <div className="text-center"><p className="text-gray-400 font-black text-[10px] uppercase text-red-500">ç´¯ç©é…æ¯</p><p className="font-black text-xl text-gray-800">{isMasked ? '****' : stats.td.toLocaleString()}</p></div>
                                </div>
                                <div className="flex-1 overflow-y-auto pb-40">
                                    <div className="grid grid-cols-4 px-6 py-3 text-[10px] text-gray-400 font-black uppercase border-b border-gray-50 bg-white sticky top-0 z-10"><span>æ¨™çš„ / è‚¡æ•¸</span><span className="text-right">ç¾åƒ¹</span><span className="text-right">{showWithDividend ? 'å«æ¯æˆæœ¬' : 'å¹³å‡æˆæœ¬'}</span><span className="text-right">æç›Š</span></div>
                                    {Object.entries(stats.inv).map(([id, d]) => d.sh > 0 && (
                                        <div key={id} onClick={() => { setSelectedStockId(id); setView('detail'); }} className="grid grid-cols-4 px-6 py-5 border-b border-gray-50 items-center active:bg-gray-50 cursor-pointer">
                                            <div><p className="font-black text-lg leading-tight">{d.n}</p><p className="text-xs text-gray-400">{id} / {d.sh.toLocaleString()}è‚¡</p></div>
                                            <div className="text-right"><p className="font-black text-lg">{marketData[id]?.p || "---"}</p><p className={`text-[10px] font-bold ${marketData[id]?.c >= 0 ? 'text-red-500' : 'text-green-600'}`}>{marketData[id]?.c >= 0 ? 'â–²' : 'â–¼'} {Math.abs(marketData[id]?.c || 0)}</p></div>
                                            <div className="text-right font-bold text-gray-600">{isMasked ? '***' : ((d.cost - (showWithDividend?d.div:0))/d.sh).toFixed(2)}</div>
                                            <div className="text-right font-black text-lg"><Mask val={(d.sh*(marketData[id]?.p||0)) - d.cost + (showWithDividend?d.div:0)} /></div>
                                        </div>
                                    ))}
                                    {Object.keys(stats.inv).length === 0 && <div className="p-10 text-center text-gray-300 font-bold text-sm">é»æ“Šä¸‹æ–¹ + è™Ÿé–‹å§‹è¨˜éŒ„ç¬¬ä¸€ç­†äº¤æ˜“</div>}
                                </div>
                            </div>
                        )}

                        {/* ç´€éŒ„ */}
                        {view === 'record' && (
                            <div className="flex flex-col h-full animate-in fade-in bg-white">
                                <div className="p-5 border-b border-gray-50 flex justify-between items-center bg-white sticky top-0 z-20">
                                    <h1 className="text-3xl font-black italic text-gray-800">äº¤æ˜“æµæ°´å¸³</h1>
                                    <button onClick={() => setRecordSortOrder(recordSortOrder === 'desc' ? 'asc' : 'desc')} className="p-2 bg-gray-50 rounded-xl active:scale-95 transition-transform"><Icon name="ArrowUpDown" size={24}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto pb-40">
                                    {(() => {
                                        const groups = {};
                                        [...transactions].sort((a,b)=>recordSortOrder==='desc' ? b.timestamp-a.timestamp : a.timestamp-b.timestamp).forEach(tx => {
                                            if (!groups[tx.date]) groups[tx.date] = { txs: [], exp: 0 };
                                            groups[tx.date].txs.push(tx);
                                            if (tx.type === 'è²·é€²') groups[tx.date].exp += Math.abs(tx.total);
                                        });
                                        if (Object.keys(groups).length === 0) return <div className="p-20 text-center text-gray-300 font-black">å°šæœªæœ‰äº¤æ˜“ç´€éŒ„</div>;
                                        
                                        return Object.entries(groups).map(([date, g]) => (
                                            <div key={date}>
                                                <div className="bg-gray-50 px-6 py-2 flex justify-between items-center border-b border-gray-100 font-black text-gray-400 text-[10px]"><span>{date}</span><span>ç•¶æ—¥æ”¯å‡º: {g.exp.toLocaleString()}</span></div>
                                                {g.txs.map(tx => (
                                                    <div key={tx.id} className="grid grid-cols-4 px-6 py-6 border-b border-gray-100 items-center">
                                                        <span className="font-black text-lg">{tx.stockName}</span>
                                                        <span className="text-center font-bold text-gray-500 text-xs">{tx.type}<br/>{tx.shares.toLocaleString()}è‚¡</span>
                                                        <span className="text-right font-black">{tx.price.toLocaleString()}</span>
                                                        <div className="flex items-center justify-end space-x-3"><span className={`font-black ${tx.total >= 0 ? 'text-red-500' : 'text-green-600'}`}>{tx.total.toLocaleString()}</span><button onClick={()=>setPendingDeleteId(tx.id)} className="text-gray-300 p-1 hover:text-red-500 transition-colors"><Icon name="Trash" size={20}/></button></div>
                                                    </div>
                                                ))}
                                            </div>
                                        ));
                                    })()}
                                </div>
                            </div>
                        )}

                        {/* è‚¡æ¯ */}
                        {view === 'dividend' && (
                            <div className="flex flex-col h-full animate-in fade-in bg-white">
                                <div className="p-5 border-b border-gray-50 flex justify-between items-center bg-white sticky top-0 z-20"><h1 className="text-3xl font-black italic text-gray-800 tracking-tighter">è‚¡æ¯çµ±è¨ˆ</h1><Icon name="Coins" size={28} className="text-blue-500"/></div>
                                <div className="flex-1 overflow-y-auto pb-40 p-6 space-y-8">
                                    {(() => {
                                        const years = {};
                                        transactions.filter(t => t.type === 'é…æ¯').forEach(tx => {
                                            const year = tx.date.split('/')[0];
                                            if (!years[year]) years[year] = { stocks: {}, total: 0 };
                                            if (!years[year].stocks[tx.stockId]) years[year].stocks[tx.stockId] = { n: tx.stockName, amt: 0 };
                                            years[year].stocks[tx.stockId].amt += Math.abs(tx.total);
                                            years[year].total += Math.abs(tx.total);
                                        });
                                        const yearEntries = Object.entries(years).sort((a,b) => b[0] - a[0]);
                                        if (yearEntries.length === 0) return <div className="p-20 text-center text-gray-300 font-black">ç„¡é ˜æ¯ç´€éŒ„</div>;

                                        return yearEntries.map(([y, d]) => (
                                            <div key={y} className="bg-gray-50 rounded-[32px] overflow-hidden border border-gray-100 shadow-sm">
                                                <div className="bg-blue-600 px-6 py-4 flex justify-between items-center text-white"><span className="text-2xl font-black">{y} å¹´åº¦</span><div className="text-right"><p className="text-[10px] font-black opacity-60 uppercase">Yearly Total</p><p className="text-xl font-black">${d.total.toLocaleString()}</p></div></div>
                                                <div className="p-4 space-y-4">{Object.entries(d.stocks).map(([id, s]) => (<div key={id} className="flex justify-between items-center px-2 border-b border-gray-100 pb-4 last:border-0 last:pb-0"><div className="flex flex-col"><span className="font-black text-lg text-gray-800">{s.n}</span><span className="text-[10px] font-black text-gray-400">{id}</span></div><span className="text-xl font-black text-red-500 tabular-nums">${s.amt.toLocaleString()}</span></div>))}</div>
                                            </div>
                                        ));
                                    })()}
                                </div>
                            </div>
                        )}

                        {/* è¨­å®š */}
                        {view === 'settings' && (
                            <div className="absolute inset-0 bg-white z-[70] flex flex-col animate-in slide-in-from-right duration-300">
                                <div className="p-6 flex items-center border-b border-gray-50 bg-white sticky top-0"><button onClick={() => setView('holding')} className="p-1"><Icon name="ChevronLeft" size={44}/></button><h2 className="flex-1 text-center font-black text-2xl tracking-tighter uppercase text-gray-800">ç³»çµ±è¨­å®š</h2><div className="w-10"></div></div>
                                <div className="p-10 space-y-8 flex-1 overflow-y-auto pb-40">
                                    <div className="space-y-3">
                                        <label className="flex items-center text-sm font-black uppercase text-gray-400 tracking-widest"><Icon name="Key" size={20} className="mr-2"/> FinMind è‚¡åƒ¹æŸ¥è©¢é‡‘é‘°</label>
                                        <input type="password" placeholder="è«‹è²¼ä¸Š FinMind API Token" className="w-full bg-gray-50 p-6 rounded-[24px] outline-none font-black text-lg border-2 border-transparent focus:border-blue-200 transition-all" value={apiToken} onChange={e => handleSaveToken(e.target.value)} />
                                        <p className="text-xs text-gray-400 font-bold px-2">â€» ç”¨æ–¼æŠ“å–æœ€æ–°å¸‚å ´è¡Œæƒ…å ±åƒ¹ã€‚</p>
                                    </div>
                                    
                                    <div className="h-px bg-gray-100 my-2"></div>
                                    
                                    <div className="space-y-3">
                                        <label className="flex items-center text-sm font-black uppercase text-gray-400 tracking-widest"><Icon name="Cloud" size={20} className="mr-2 text-blue-500"/> Firebase é›²ç«¯åŒæ­¥é‡‘é‘°</label>
                                        <p className="text-xs text-gray-400 font-bold px-2 pb-1">è«‹å°‡ Firebase ç”¢ç”Ÿçš„è¨­å®šç¨‹å¼ç¢¼ï¼ˆåŒ…å«å¤§æ‹¬è™Ÿï¼‰ç›´æ¥è²¼å…¥ä¸‹æ–¹ï¼š</p>
                                        <textarea 
                                            placeholder='{&#10;  apiKey: "AIza...",&#10;  authDomain: "...",&#10;  projectId: "..."&#10;}' 
                                            className="w-full h-40 bg-blue-50/50 p-4 rounded-[24px] outline-none font-mono text-xs border-2 border-transparent focus:border-blue-200 transition-all resize-none text-gray-600" 
                                            value={fbConfigInput} 
                                            onChange={e => setFbConfigInput(e.target.value)} 
                                        />
                                        <div className="flex space-x-3 pt-2">
                                            <button onClick={handleSaveFbConfig} className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black active:scale-95 transition-transform shadow-lg shadow-blue-200">å¥—ç”¨é›²ç«¯è¨­å®š</button>
                                            <button onClick={handleClearFbConfig} className="flex-1 py-4 bg-gray-200 text-gray-600 rounded-2xl font-black active:scale-95 transition-transform">æ¸…é™¤ (åˆ‡å›å–®æ©Ÿ)</button>
                                        </div>
                                    </div>

                                    <div className="h-px bg-gray-100 my-2"></div>

                                    <button onClick={() => { const b = new Blob([JSON.stringify(transactions)], {type: 'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'stockify_backup.json'; a.click(); }} className="w-full py-6 bg-gray-900 text-white rounded-[24px] font-black text-lg flex items-center justify-center space-x-3 active:scale-95 shadow-xl transition-all"><Icon name="Download" size={28}/><span>åŒ¯å‡ºç´€éŒ„å‚™ä»½ (.json)</span></button>
                                    
                                    {!isFirebaseConfigured && (
                                        <label className="w-full py-6 border-2 border-gray-200 text-gray-500 rounded-[24px] font-black text-lg flex items-center justify-center space-x-3 cursor-pointer active:bg-gray-50 transition-colors">
                                            <Icon name="Upload" size={28}/><span>åŒ¯å…¥ç´€éŒ„æª”</span>
                                            <input type="file" className="hidden" accept=".json" onChange={handleImport} />
                                        </label>
                                    )}
                                    <div className="text-center pt-2">
                                        <p className="text-gray-400 font-black text-[10px] uppercase tracking-widest bg-gray-50 inline-block px-4 py-2 rounded-full border border-gray-100">
                                            ç›®å‰å„²å­˜æ¨¡å¼: {isFirebaseConfigured ? <span className="text-blue-500">é›²ç«¯æ¨¡å¼ ({user?.uid?.substring(0,6)})</span> : <span className="text-orange-500">å–®æ©Ÿæ¨¡å¼ (åƒ…å­˜ç€è¦½å™¨)</span>}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* å€‹è‚¡è©³æƒ… */}
                        {view === 'detail' && selectedStockId && (
                            <div className="flex flex-col h-full animate-in slide-in-from-right bg-white overflow-hidden">
                                <div className="p-5 flex items-center border-b border-gray-50 sticky top-0 bg-white z-10"><button onClick={() => setView('holding')} className="p-1"><Icon name="ChevronLeft" size={40}/></button><h2 className="flex-1 text-center font-black text-2xl tracking-tight uppercase tracking-tighter">{selectedStockId} {stockMaster[selectedStockId]?.n}</h2><button onClick={() => { setFormCode(selectedStockId); setView('add'); }} className="p-1 text-blue-500 active:scale-90 transition-transform"><Icon name="Plus" size={40}/></button></div>
                                {(() => {
                                    const d = stats.inv[selectedStockId];
                                    if (!d) return null;
                                    const m = marketData[selectedStockId] || { p: 0, c: 0 };
                                    const unrealized = (d.sh * m.p) - d.cost, profitToShow = showWithDividend ? unrealized + d.div : unrealized;
                                    const avg = d.sh > 0 ? (d.cost / d.sh) : 0, divP = d.sh > 0 ? (d.div / d.sh) : 0, displayA = showWithDividend ? (avg - divP).toFixed(2) : avg.toFixed(2);
                                    return (
                                        <div className="flex-1 flex flex-col overflow-hidden">
                                            <div className={`px-6 py-5 flex justify-between items-center ${m.c >= 0 ? 'bg-red-50' : 'bg-green-50'}`}><div className={`font-black text-3xl ${m.c >= 0 ? 'text-red-500' : 'text-green-600'}`}>{m.p} <span className="text-base font-bold ml-1">{m.c >= 0 ? 'â–²' : 'â–¼'} {Math.abs(m.c)}</span></div><button onClick={()=>setShowWithDividend(!showWithDividend)} className="px-3 py-1.5 rounded-full bg-white border border-gray-200 text-xs font-black shadow-sm flex items-center space-x-1 transition-all active:scale-95">{showWithDividend ? <Icon name="ToggleRight" size={18} className="text-blue-500"/> : <Icon name="ToggleLeft" size={18} className="text-gray-300"/>} <span>{showWithDividend ? 'å«æ¯' : 'é™¤æ¯'}</span></button></div>
                                            <div className="p-8 border-b border-gray-50"><p className="text-gray-400 text-sm font-black uppercase mb-1 leading-none">{showWithDividend ? 'ç´¯ç©æç›Š (å«æ¯)' : 'æŒè‚¡æœªå¯¦ç¾æç›Š'}</p><h3 className={`text-5xl font-black tabular-nums tracking-tighter`}><Mask val={profitToShow} /></h3>
                                                <div className="grid grid-cols-3 gap-y-12 mt-12 text-center text-[13px]">
                                                    <div className="text-left leading-tight"><p className="text-gray-400 font-black uppercase tracking-tight">{showWithDividend ? 'å«æ¯æˆæœ¬' : 'å¹³å‡æˆæœ¬'}</p><p className="font-black text-2xl text-gray-800">{isMasked ? '***' : displayA}</p></div>
                                                    <div><p className="text-gray-400 font-black uppercase text-blue-600">å·²å¯¦ç¾æç›Š</p><p className={`font-black text-2xl`}><Mask val={d.realized} /></p></div>
                                                    <div className="text-right"><p className="text-gray-400 font-black uppercase">æŒè‚¡æ•¸</p><p className="font-black text-2xl text-gray-800">{d.sh.toLocaleString()}</p></div>
                                                    <div className="text-left leading-tight"><p className="text-gray-400 font-black uppercase">ä»Šæ—¥ç›ˆè™§</p><p className="font-black text-2xl"><Mask val={d.sh * m.c} /></p></div>
                                                    <div><p className="text-gray-400 font-black uppercase">æŒè‚¡å¸‚å€¼</p><p className="font-black text-2xl text-gray-800">{(d.sh * m.p).toLocaleString()}</p></div>
                                                    <div className="text-right"><p className="text-gray-400 font-black uppercase text-red-500">ç´¯ç©é…æ¯</p><p className="font-black text-2xl text-gray-800">{d.div.toLocaleString()}</p></div>
                                                </div>
                                            </div>
                                            <div className="flex-1 overflow-y-auto bg-gray-50/40 pb-10"><div className="grid grid-cols-4 px-6 py-3 text-xs text-gray-400 font-black uppercase border-b border-gray-100 bg-white sticky top-0 z-10"><span>æ—¥æœŸ</span><span className="text-center">äº¤æ˜“</span><span className="text-right">åƒ¹æ ¼</span><span className="text-right">æ”¶æ”¯</span></div>{d.history.sort((a,b)=>b.timestamp-a.timestamp).map(tx => (<div key={tx.id} className="grid grid-cols-4 px-6 py-8 border-b border-gray-50 text-base items-center hover:bg-white group"><span className="font-black text-gray-400 text-sm">{tx.date.substring(5)}</span><span className="text-center font-black text-gray-800 text-xs">{tx.type} {tx.shares > 0 ? `${tx.shares.toLocaleString()}è‚¡` : ''}</span><span className="text-right font-black">{tx.price > 0 ? tx.price.toLocaleString() : '-'}</span><div className="text-right flex items-center justify-end space-x-4"><Mask val={tx.total} /><button onClick={() => setPendingDeleteId(tx.id)} className="text-gray-300 hover:text-red-400 transition-colors p-1"><Icon name="Trash" size={24}/></button></div></div>))}</div>
                                        </div>
                                    )
                                })()}
                            </div>
                        )}
                    </div>

                    {/* æ‡¸æµ®å°è¦½å³¶ */}
                    <div className="absolute bottom-8 left-6 right-6 h-20 bg-white/90 backdrop-blur-2xl border border-white/50 rounded-[32px] flex items-center justify-between px-6 z-50 shadow-2xl">
                        <div className="flex flex-1 justify-around items-center pr-10">
                            <button onClick={() => setView('holding')} className={`flex flex-col items-center ${view==='holding'?'text-blue-600':'text-gray-300'} active:scale-95 transition-transform`}><Icon name="PieChart" size={28}/><span className="text-[9px] font-black mt-1 uppercase">æŒè‚¡</span></button>
                            <button onClick={() => setView('record')} className={`flex flex-col items-center ${view==='record'?'text-blue-600':'text-gray-300'} active:scale-95 transition-transform`}><Icon name="History" size={28}/><span className="text-[9px] font-black mt-1 uppercase">ç´€éŒ„</span></button>
                        </div>
                        <div className="flex flex-1 justify-around items-center pl-10">
                            <button onClick={() => setView('dividend')} className={`flex flex-col items-center ${view==='dividend'?'text-blue-600':'text-gray-300'} active:scale-95 transition-transform`}><Icon name="Coins" size={28}/><span className="text-[9px] font-black mt-1 uppercase">è‚¡æ¯</span></button>
                            <button onClick={syncMarketData} className={`flex flex-col items-center ${isUpdating?'animate-spin text-blue-400':'text-gray-300'} active:scale-95 transition-transform`}><Icon name="Refresh" size={28}/><span className="text-[9px] font-black mt-1 uppercase">åŒæ­¥</span></button>
                        </div>
                    </div>
                    <button onClick={() => setView('add')} className="absolute bottom-10 left-1/2 -translate-x-1/2 w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white z-[60] shadow-xl border-[6px] border-gray-50 active:scale-90 transition-all">
                        <Icon name="Plus" size={48}/>
                    </button>

                    {/* æ–°å¢ç´€éŒ„å½ˆçª— */}
                    <div className={`absolute inset-0 bg-white z-[100] flex flex-col transition-all duration-300 transform ${view === 'add' ? 'translate-y-0' : 'translate-y-full pointer-events-none'}`}>
                        <div className="p-5 flex items-center border-b border-gray-50 bg-white sticky top-0"><button onClick={() => setView('holding')}><Icon name="ChevronLeft" size={40}/></button><h2 className="flex-1 text-center font-black text-2xl uppercase tracking-tighter">æ–°å¢ç´€éŒ„</h2><div className="w-10"></div></div>
                        <div className="p-10 space-y-12 flex-1 overflow-y-auto pb-48 bg-white">
                            <div className="space-y-4">
                                <div className="flex items-center space-x-6"><label className="text-gray-400 font-black text-sm uppercase w-20">è‚¡ç¥¨ä»£è™Ÿ</label><input className="flex-1 bg-gray-50 p-6 rounded-[24px] outline-none font-black text-2xl uppercase" placeholder="å¦‚ 2330" value={formCode} onChange={e=>setFormCode(e.target.value)} /></div>
                                <div className="ml-28 font-black text-blue-600 text-xl">{isSearchingName ? "æœå°‹ä¸­..." : (stockMaster[formCode.toUpperCase()]?.n || "è¼¸å…¥ä»£è™Ÿç¢ºèª")}</div>
                            </div>
                            <div className="flex items-center space-x-6"><label className="text-gray-400 font-black text-sm uppercase w-20">æˆäº¤æ—¥æœŸ</label><div className="flex-1 relative"><input type="date" className="w-full bg-gray-50 p-6 rounded-[24px] outline-none font-black text-xl" value={formDate} onChange={e=>setFormDate(e.target.value)} /><Icon name="Calendar" className="absolute right-6 top-6 text-gray-300 pointer-events-none" size={24}/></div></div>
                            <div className="flex items-center space-x-6"><label className="text-gray-400 font-black text-sm uppercase w-20 shrink-0">äº¤æ˜“å‹•ä½œ</label><div className="flex space-x-4">{['è²·é€²','è³£å‡º','é…æ¯'].map(t=>(<button key={t} onClick={()=>setActiveTab(t)} className={`px-10 py-4 rounded-full text-lg font-black transition-all ${activeTab===t?'bg-blue-600 text-white shadow-xl':'bg-gray-100 text-gray-400'}`}>{t}</button>))}</div></div>
                            <div className="space-y-10">
                                {activeTab === 'é…æ¯' ? (
                                    <React.Fragment>
                                        <div className="flex items-center border-b border-gray-100 pb-6"><label className="text-gray-400 font-black text-sm uppercase w-20 leading-none">é…ç™¼é‡‘é¡</label><input type="number" value={formTotalAmount} onChange={e=>setFormTotalAmount(e.target.value)} className="flex-1 ml-8 outline-none font-black text-3xl text-blue-600" placeholder="0" /></div>
                                        <div className="text-center text-gray-200 font-bold text-xs uppercase tracking-[5px]">æˆ–æ˜¯è¨ˆç®—</div>
                                        <div className="flex items-center border-b border-gray-100 pb-6"><label className="text-gray-400 font-black text-sm uppercase w-20">æ¯è‚¡è‚¡æ¯</label><input type="number" value={formPrice} onChange={e=>setFormPrice(e.target.value)} className="flex-1 ml-8 outline-none font-black text-3xl" placeholder="0.00" /></div>
                                        <div className="flex items-center border-b border-gray-100 pb-6"><label className="text-gray-400 font-black text-sm uppercase w-20">é™¤æ¯è‚¡æ•¸</label><input type="number" value={formShares} onChange={e=>setFormShares(e.target.value)} className="flex-1 ml-8 outline-none font-black text-3xl" placeholder="0" /></div>
                                    </React.Fragment>
                                ) : (
                                    <React.Fragment>
                                        <div className="flex items-center border-b border-gray-100 pb-6"><label className="text-gray-400 font-black text-sm uppercase w-20">æˆäº¤åƒ¹æ ¼</label><input type="number" value={formPrice} onChange={e=>setFormPrice(e.target.value)} className="flex-1 ml-8 outline-none font-black text-3xl" placeholder="0.00" /></div>
                                        <div className="flex items-center border-b border-gray-100 pb-6"><label className="text-gray-400 font-black text-sm uppercase w-20">æˆäº¤è‚¡æ•¸</label><input type="number" value={formShares} onChange={e=>setFormShares(e.target.value)} className="flex-1 ml-8 outline-none font-black text-3xl" placeholder="0" /></div>
                                    </React.Fragment>
                                )}
                            </div>
                            <div className="bg-blue-50/50 p-10 rounded-[40px] border border-blue-100/50"><div className="flex justify-between font-black text-blue-900 items-baseline"><span>{activeTab==='è²·é€²'?'é è¨ˆç¸½æ”¯å‡º':activeTab==='è³£å‡º'?'é è¨ˆç¸½æ”¶å…¥':'æœ€çµ‚å…¥å¸³'}</span><span className="text-5xl tabular-nums tracking-tighter">$ {Math.abs(calc.total).toLocaleString()}</span></div></div>
                        </div>
                        <div className="absolute bottom-0 left-0 right-0 p-8 grid grid-cols-2 gap-5 border-t border-gray-100 bg-white/95 backdrop-blur-md z-10 shadow-2xl"><button onClick={()=>saveTx(true)} className="py-6 border-2 border-blue-600 text-blue-600 rounded-[24px] font-black text-xl active:scale-95 transition-transform">å†è¨˜ä¸€ç­†</button><button onClick={()=>saveTx(false)} className="py-6 bg-blue-600 text-white rounded-[24px] font-black text-xl shadow-xl shadow-blue-100 active:scale-95 transition-transform">å®Œæˆå­˜æª”</button></div>
                    </div>

                    {/* åˆªé™¤ç¢ºèªå½ˆçª— */}
                    {pendingDeleteId && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[200] flex items-center justify-center p-8">
                            <div className="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-2xl animate-in zoom-in-95">
                                <div className="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500"><Icon name="AlertCircle" size={32} /></div>
                                <h3 className="text-2xl font-black text-center mb-2 text-gray-800 tracking-tighter">ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ</h3>
                                <p className="text-gray-500 text-center mb-8 font-bold text-sm">åˆªé™¤å¾Œè³‡æ–™å°‡ç„¡æ³•é‚„åŸï¼Œä¸”æœƒé‡æ–°è¨ˆç®—è³‡ç”¢æ•¸æ“šã€‚</p>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={()=>setPendingDeleteId(null)} className="py-4 bg-gray-100 rounded-2xl font-black text-gray-500 active:scale-95 transition-transform">å–æ¶ˆ</button>
                                    <button onClick={confirmDelete} className="py-4 bg-red-500 rounded-2xl font-black text-white shadow-lg active:scale-95 transition-transform">ç¢ºèªåˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
