<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- åŠ å…¥ viewport-fit=cover è®“ iPhone è­˜åˆ¥å®‰å…¨å€åŸŸï¼Œä¸¦ç¦æ­¢ç¸®æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stockify å°ˆæ¥­ç‰ˆ v4.3.4</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* ğŸ”¥ çµ‚æ¥µ iOS é«˜åº¦ä¿®å¾©ï¼šæŠŠç¶²é å››è§’å®Œå…¨é‡˜æ­»åœ¨å¯è¦–å€åŸŸå…§ ğŸ”¥ */
        html, body {
            position: fixed;
            top: 0; bottom: 0; left: 0; right: 0;
            width: 100%; height: 100%;
            margin: 0; padding: 0;
            overflow: hidden; /* é–æ­»å¤–å±¤ï¼Œé˜²æ­¢è¢« Safari æ‹‰æ‰¯ */
            background-color: #f3f4f6;
            font-family: 'Inter', "Microsoft JhengHei", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        #root { width: 100%; height: 100%; }

        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent; bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }

        /* åº•éƒ¨å®‰å…¨è·é›¢é©é… (é–ƒé¿ iPhone åº•éƒ¨çš„ç™½æ¢) */
        .nav-island { bottom: calc(16px + env(safe-area-inset-bottom, 0px)); }
        .fab-btn { bottom: calc(24px + env(safe-area-inset-bottom, 0px)); }
        .safe-pb { padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)); }

        @media (min-width: 640px) {
            .nav-island { bottom: 32px; }
            .fab-btn { bottom: 40px; }
            .safe-pb { padding-bottom: 32px; }
        }
        
        /* éš±è— Chrome/Safari æ•¸å­—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase è¨­å®š ---
        const localFbConfigStr = localStorage.getItem('stockify_firebase_config');
        let parsedLocalFbConfig = null;
        try { if (localFbConfigStr) parsedLocalFbConfig = JSON.parse(localFbConfigStr); } catch(e) {}

        const firebaseConfig = parsedLocalFbConfig || (window.__firebase_config ? JSON.parse(window.__firebase_config) : {
            apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: ""
        });

        const isFirebaseConfigured = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey.trim() !== "";
        let auth = null, db = null;
        if (isFirebaseConfigured) {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        }

        const APP_VERSION = 'v4.3.4 (UX Fix)';
        const TOKEN_KEY = 'stockify_token';
        const MY_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRlIjoiMjAyNi0wMy0wMSAwMjowOTo0OCIsInVzZXJfaWQiOiJob25nYm95IiwiZW1haWwiOiJob25nYm95OTJAZ21haWwuY29tIiwiaXAiOiI2MS4yMjAuOTMuNzQifQ.Mk4GPZsGRLM79QvxVHIcRXE5y_FThk9uMCsoJfmQCYc";
        const STORAGE_KEY = 'stockify_v4_txs';
        const MASTER_KEY = 'stockify_v4_master';

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                PieChart: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z"/>,
                History: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-4v4h4"/>,
                Plus: <path d="M12 5v14M5 12h14"/>,
                Coins: <React.Fragment><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18.1"/></React.Fragment>,
                Refresh: <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>,
                Settings: <React.Fragment><path d="M12.22 2h-.44a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2a2 2 0 0 1 2 2a2 2 0 0 0 2 2a2 2 0 0 1 2 2a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0 2-2v-.44a2 2 0 0 0-2-2a2 2 0 0 1-2-2a2 2 0 0 0-2-2a2 2 0 0 1-2-2a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></React.Fragment>,
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                ArrowUpDown: <path d="m21 16-4 4-4-4M21 20V12M3 8l4-4 4 4M3 4v8"/>,
                ToggleLeft: <React.Fragment><rect width="20" height="12" x="2" y="6" rx="6"/><circle cx="8" cy="12" r="2"/></React.Fragment>,
                ToggleRight: <React.Fragment><rect width="20" height="12" x="2" y="6" rx="6" fill="#3B82F6"/><circle cx="16" cy="12" r="2" fill="white"/></React.Fragment>,
                Trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>,
                Calendar: <React.Fragment><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></React.Fragment>,
                Key: <React.Fragment><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3v-3.5L15.5 7.5z"/></React.Fragment>,
                Download: <React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5 5 5-5m-5 5V3"/></React.Fragment>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-4v4h4"/>,
                AlertCircle: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></React.Fragment>,
                Loader2: <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>,
                CheckCircle2: <React.Fragment><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></React.Fragment>,
                Upload: <React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5-5-5-5 5m5-5v12"/></React.Fragment>,
                Cloud: <React.Fragment><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></React.Fragment>
            };
            return (
                <svg width={className ? "100%" : size} height={className ? "100%" : size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" stroke="red" />}
                </svg>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [isCloudLoading, setIsCloudLoading] = useState(true);
            const [view, setView] = useState('holding'); 
            const [transactions, setTransactions] = useState([]);
            const [stockMaster, setStockMaster] = useState({}); 
            const [marketData, setMarketData] = useState({}); 
            const [apiToken, setApiToken] = useState(''); 
            const [fbConfigInput, setFbConfigInput] = useState(localFbConfigStr || ''); 
            const [isUpdating, setIsUpdating] = useState(false);
            const [isMasked, setIsMasked] = useState(false);
            const [showWithDividend, setShowWithDividend] = useState(true); 
            const [selectedStockId, setSelectedStockId] = useState(null);
            const [pendingDeleteId, setPendingDeleteId] = useState(null);
            const [recordSortOrder, setRecordSortOrder] = useState('desc'); 

            // è¡¨å–®èˆ‡äº’å‹•ç‹€æ…‹
            const [formCode, setFormCode] = useState('');
            const [formDate, setFormDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState('è²·é€²');
            const [formTotalAmount, setFormTotalAmount] = useState(''); 
            const [formPrice, setFormPrice] = useState('');     
            const [formShares, setFormShares] = useState('');   
            const [formFee, setFormFee] = useState('');         
            const [isSearchingName, setIsSearchingName] = useState(false);
            
            // å­˜æª”èˆ‡ UI å›é¥‹ç‹€æ…‹
            const [isSaving, setIsSaving] = useState(false);
            const [toastMsg, setToastMsg] = useState('');

            useEffect(() => {
                const savedToken = localStorage.getItem(TOKEN_KEY);
                setApiToken(savedToken || MY_TOKEN);

                if (!isFirebaseConfigured || !auth) {
                    const savedTxs = localStorage.getItem(STORAGE_KEY);
                    const savedMaster = localStorage.getItem(MASTER_KEY);
                    if (savedTxs) setTransactions(JSON.parse(savedTxs));
                    if (savedMaster) setStockMaster(JSON.parse(savedMaster));
                    setIsCloudLoading(false);
                    return;
                }

                const unsubscribe = auth.onAuthStateChanged(async (currUser) => {
                    if (!currUser) {
                        try { await auth.signInAnonymously(); } catch (e) { console.error(e); }
                    } else {
                        setUser(currUser);
                        setIsCloudLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isFirebaseConfigured || !user || !db) return;
                const appIdStr = window.__app_id || 'stockify-v4';
                const txRef = db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('transactions');
                const unsub = txRef.onSnapshot(snap => {
                    setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                const masterRef = db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('settings').doc('master');
                const unsubM = masterRef.onSnapshot(doc => {
                    if (doc.exists) setStockMaster(doc.data());
                });
                return () => { unsub(); unsubM(); };
            }, [user]);

            const syncMarketData = async () => {
                if (isUpdating || !apiToken) return;
                const codes = [...new Set(transactions.map(t => t.stockId))];
                if (codes.length === 0) return;
                setIsUpdating(true);
                try {
                    const newMarket = { ...marketData };
                    const dateLimit = new Date(); dateLimit.setDate(dateLimit.getDate() - 7);
                    const dateStr = dateLimit.toISOString().split('T')[0];
                    for (const code of codes) {
                        const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${code}&start_date=${dateStr}&token=${apiToken}`;
                        const resp = await fetch(url);
                        const json = await resp.json();
                        if (json.msg === 'success' && json.data && json.data.length > 0) {
                            const latest = json.data[json.data.length - 1];
                            const prev = json.data.length > 1 ? json.data[json.data.length - 2] : latest;
                            newMarket[code] = { p: latest.close, c: parseFloat((latest.close - prev.close).toFixed(2)) };
                        }
                    }
                    setMarketData(newMarket);
                } catch (e) { console.error(e); } 
                finally { setIsUpdating(false); }
            };

            const fetchStockInfo = async (code) => {
                if (!apiToken) return;
                setIsSearchingName(true);
                try {
                    const resp = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInfo&data_id=${code}&token=${apiToken}`);
                    const json = await resp.json();
                    if (json.msg === 'success' && json.data && json.data.length > 0) {
                        const info = json.data[0];
                        const newM = { ...stockMaster, [code]: { n: info.stock_name, t: code.endsWith('B') ? 'BondETF' : (code.startsWith('00') ? 'StockETF' : 'Stock') } };
                        setStockMaster(newM);
                        
                        if (isFirebaseConfigured && user && db) {
                            const appIdStr = window.__app_id || 'stockify-v4';
                            await db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('settings').doc('master').set(newM);
                        } else {
                            localStorage.setItem(MASTER_KEY, JSON.stringify(newM));
                        }
                    }
                } catch (e) { console.error(e); } 
                finally { setIsSearchingName(false); }
            };

            useEffect(() => {
                const code = formCode.toUpperCase();
                if (code.length < 2 || stockMaster[code]) return;
                const t = setTimeout(() => fetchStockInfo(code), 600);
                return () => clearTimeout(t);
            }, [formCode]);

            const stats = useMemo(() => {
                const inv = {};
                [...transactions].sort((a,b)=>a.timestamp - b.timestamp).forEach(tx => {
                    const id = tx.stockId;
                    if (!inv[id]) inv[id] = { sh: 0, cost: 0, div: 0, realized: 0, n: tx.stockName, history: [] };
                    inv[id].history.push(tx);
                    if (tx.type === 'è²·é€²') { inv[id].sh += tx.shares; inv[id].cost += Math.abs(tx.total); }
                    else if (tx.type === 'è³£å‡º' && inv[id].sh > 0) {
                        const avg = inv[id].cost / inv[id].sh;
                        const soldCost = tx.shares * avg;
                        inv[id].realized += (tx.total - soldCost);
                        inv[id].cost -= soldCost; inv[id].sh -= tx.shares;
                    }
                    else if (tx.type === 'é…æ¯') { inv[id].div += Math.abs(tx.total); }
                });
                let mv = 0, remC = 0, dp = 0, td = 0;
                Object.entries(inv).forEach(([id, d]) => {
                    const m = marketData[id] || { p: 0, c: 0 };
                    mv += d.sh * m.p; remC += d.cost; dp += d.sh * m.c; td += d.div;
                });
                const unrealized = mv - remC;
                const profit = showWithDividend ? unrealized + td : unrealized;
                return { profit, pct: remC > 0 ? (profit/remC*100) : 0, mv, remC, dp, td, inv };
            }, [transactions, marketData, showWithDividend]);

            const calc = useMemo(() => {
                if (activeTab === 'é…æ¯') {
                    if (formTotalAmount) return { total: Math.round(parseFloat(formTotalAmount) || 0), fee: 0, autoFee: 0 };
                    return { 
                        total: Math.round((parseFloat(formPrice)||0) * (parseInt(formShares)||0) - (parseFloat(formFee)||0)), 
                        fee: parseFloat(formFee)||0, 
                        autoFee: 0 
                    };
                }
                const amt = (parseFloat(formPrice)||0) * (parseInt(formShares)||0);
                
                let autoF = Math.floor(amt * 0.001425 * 0.6); if (autoF < 20 && amt > 0) autoF = 20;
                let tr = 0.003; if (formCode.endsWith('B')) tr = 0; else if (formCode.startsWith('00')) tr = 0.001;
                const autoTax = activeTab === 'è³£å‡º' ? Math.floor(amt * tr) : 0;
                const autoTotalFee = autoF + autoTax;

                const finalFee = formFee !== '' ? (parseFloat(formFee) || 0) : autoTotalFee;
                const finalTotal = activeTab === 'è²·é€²' ? -(amt + finalFee) : (amt - finalFee);

                return { total: Math.round(finalTotal), fee: finalFee, autoFee: autoTotalFee };
            }, [formPrice, formShares, formFee, formTotalAmount, activeTab, formCode]);

            // --- 4. å­˜æª”é‚è¼¯ (åŠ å…¥å»¶é²è™•ç†èˆ‡ UI å›é¥‹) ---
            const saveTx = async (stay) => {
                if (!formCode || (activeTab !== 'é…æ¯' && (!formPrice || !formShares))) {
                    alert("è«‹ç¢ºå¯¦å¡«å¯«ä»£è™Ÿèˆ‡é‡‘é¡/è‚¡æ•¸");
                    return;
                }
                
                setIsSaving(true); // å•Ÿå‹•è¼‰å…¥ç‹€æ…‹
                const code = formCode.toUpperCase();
                const newTx = {
                    stockId: code, 
                    stockName: stockMaster[code]?.n || `æ¨™çš„ ${code}`,
                    type: activeTab, 
                    price: parseFloat(formPrice)||0, 
                    shares: parseInt(formShares)||0,
                    total: calc.total, 
                    date: formDate.replace(/-/g, '/'), 
                    timestamp: Date.now()
                };

                try {
                    if (isFirebaseConfigured && user && db) {
                        const appIdStr = window.__app_id || 'stockify-v4';
                        await db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('transactions').add(newTx);
                    } else {
                        newTx.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                        const updated = [newTx, ...transactions];
                        setTransactions(updated);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                    }

                    if (stay) {
                        // å†è¨˜ä¸€ç­†ï¼šæ¸…ç©ºæ•¸å­—ï¼Œä¿ç•™ä»£è™Ÿèˆ‡æ—¥æœŸï¼Œä¸¦è·³å‡ºæˆåŠŸæç¤º
                        setFormPrice(''); setFormShares(''); setFormFee(''); setFormTotalAmount('');
                        setToastMsg('ğŸ‰ å„²å­˜æˆåŠŸï¼è«‹è¼¸å…¥ä¸‹ä¸€ç­†');
                        setTimeout(() => setToastMsg(''), 3000); // 3ç§’å¾Œæ¶ˆå¤±
                    } else {
                        // å®Œæˆå­˜æª”ï¼šå›åˆ°é¦–é 
                        setFormCode(''); setFormPrice(''); setFormShares(''); setFormFee(''); setFormTotalAmount('');
                        setView('holding');
                    }
                } catch (e) { 
                    console.error(e); 
                    alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹");
                } finally {
                    setIsSaving(false); // é—œé–‰è¼‰å…¥ç‹€æ…‹
                }
            };

            const confirmDelete = async () => {
                if (isFirebaseConfigured && user && db && pendingDeleteId) {
                    try {
                        const appIdStr = window.__app_id || 'stockify-v4';
                        await db.collection('artifacts').doc(appIdStr).collection('users').doc(user.uid).collection('transactions').doc(pendingDeleteId).delete();
                    } catch (e) { console.error(e); }
                } else {
                    const updated = transactions.filter(t => t.id !== pendingDeleteId);
                    setTransactions(updated);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                }
                
                setPendingDeleteId(null);
                const remainingForThisStock = transactions.filter(t => t.stockId === selectedStockId && t.id !== pendingDeleteId);
                if (view === 'detail' && remainingForThisStock.length === 0) setView('holding');
            };

            const handleSaveToken = (token) => { 
                setApiToken(token); 
                localStorage.setItem(TOKEN_KEY, token); 
            };
            
            const handleSaveFbConfig = () => {
                let input = fbConfigInput.trim();
                if(!input) return;
                try {
                    if (input.includes('=')) input = input.substring(input.indexOf('=') + 1).trim();
                    if (input.endsWith(';')) input = input.slice(0, -1).trim();
                    const parsed = new Function("return " + input)();
                    if (!parsed || !parsed.apiKey) throw new Error("æ‰¾ä¸åˆ° apiKeyï¼Œè«‹ç¢ºèªå…§å®¹å®Œæ•´");
                    localStorage.setItem('stockify_firebase_config', JSON.stringify(parsed));
                    alert("ğŸ‰ Firebase é›²ç«¯è¨­å®šå·²æˆåŠŸå¥—ç”¨ï¼\nç³»çµ±å°‡ç‚ºæ‚¨é‡æ–°è¼‰å…¥é é¢é€£ç·šé›²ç«¯ã€‚");
                    window.location.reload();
                } catch(e) {
                    alert("âŒ è§£æå¤±æ•—ï¼\nè«‹ç›´æ¥å¾ Firebase æ§åˆ¶å°è¤‡è£½åŒ…å«å¤§æ‹¬è™Ÿ { ... } çš„å®Œæ•´å€å¡Šè²¼ä¸Šã€‚\n\nè©³ç´°éŒ¯èª¤: " + e.message);
                }
            };

            const handleClearFbConfig = () => {
                localStorage.removeItem('stockify_firebase_config');
                alert("å·²åˆ‡æ›å›å–®æ©Ÿæ¨¡å¼ï¼\nç³»çµ±å°‡é‡æ–°è¼‰å…¥é é¢ã€‚");
                window.location.reload();
            };

            const handleImport = (e) => {
                const reader = new FileReader();
                reader.onload = ev => { 
                    try {
                        const importedData = JSON.parse(ev.target.result);
                        if(Array.isArray(importedData)) {
                            setTransactions(importedData);
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
                            setView('holding');
                            alert("è³‡æ–™åŒ¯å…¥æˆåŠŸï¼");
                        }
                    } catch (err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
                };
                if(e.target.files[0]) reader.readAsText(e.target.files[0]);
            };

            const Mask = ({ val }) => isMasked ? "****" : <span className={val >= 0 ? 'text-red-500' : 'text-green-600'}>{val.toLocaleString(undefined, {maximumFractionDigits:0})}</span>;

            if (isCloudLoading) return <div className="h-full w-full flex flex-col items-center justify-center bg-white"><div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div><p className="font-black text-blue-500 italic uppercase">Initializing...</p></div>;

            // å¤–å±¤å®¹å™¨ä½¿ç”¨ h-full å¡«æ»¿é–æ­»çš„ viewport
            return (
                <div className="app-container">
                    
                    {/* ===== æ ¸å¿ƒç•«é¢å€åŸŸ ===== */}
                    <div className="flex-1 flex flex-col overflow-hidden relative bg-white">
                        
                        {/* 1. é¦–é  */}
                        {view === 'holding' && (
                            <React.Fragment>
                                <div className="p-4 sm:p-6 flex justify-between items-center border-b border-gray-50 bg-white shrink-0">
                                    <div className="flex flex-col">
                                        <h1 className="text-2xl sm:text-3xl font-black italic text-gray-800 tracking-tighter">St<span className="text-blue-600">o</span>ckify</h1>
                                        <p className="text-[9px] sm:text-[10px] text-gray-400 font-bold ml-1 uppercase tracking-widest">{APP_VERSION} â€¢ {isFirebaseConfigured ? <span className="text-blue-500">Cloud</span> : 'Local'}</p>
                                    </div>
                                    <div className="flex space-x-2 sm:space-x-3">
                                        <button onClick={() => setIsMasked(!isMasked)} className="p-2 text-gray-300 active:scale-95"><Icon name="RotateCcw" className="w-5 h-5 sm:w-6 sm:h-6"/></button>
                                        <button onClick={() => setView('settings')} className="p-2 text-gray-400 active:scale-95"><Icon name="Settings" className="w-5 h-5 sm:w-6 sm:h-6"/></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto overflow-x-hidden pb-[140px] sm:pb-[160px]">
                                    <div className="px-4 sm:px-6 py-4 sm:py-6">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-gray-400 font-bold text-[10px] sm:text-xs uppercase tracking-widest">{showWithDividend ? 'ç´¯ç©æç›Š (å«æ¯)' : 'æœªå¯¦ç¾æç›Š'}</span>
                                            <button onClick={() => setShowWithDividend(!showWithDividend)} className={`px-2 py-1 sm:px-3 sm:py-1.5 rounded-lg sm:rounded-xl border text-[10px] sm:text-xs font-black flex items-center space-x-1 ${showWithDividend ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-gray-50 text-gray-400 border-gray-100'}`}>
                                                {showWithDividend ? <Icon name="ToggleRight" className="w-4 h-4 sm:w-5 sm:h-5"/> : <Icon name="ToggleLeft" className="w-4 h-4 sm:w-5 sm:h-5"/>} <span>{showWithDividend ? 'å«æ¯' : 'é™¤æ¯'}</span>
                                            </button>
                                        </div>
                                        <div className="flex items-baseline space-x-2 sm:space-x-3 mt-1 sm:mt-0">
                                            <span className="text-4xl sm:text-5xl font-black tabular-nums tracking-tighter"><Mask val={stats.profit} /></span>
                                            <span className={`text-base sm:text-xl font-black ${stats.profit >= 0 ? 'text-red-500' : 'text-green-600'}`}>{isMasked ? '***' : `${stats.profit >= 0 ? '+' : ''}${stats.pct.toFixed(2)}%`}</span>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 px-2 sm:px-6 py-4 sm:py-6 border-y border-gray-100 bg-gray-50/40">
                                        <div className="text-center"><p className="text-gray-400 font-black text-[9px] sm:text-[10px] uppercase">ä»Šæ—¥æç›Š</p><p className="font-black text-base sm:text-xl mt-0.5"><Mask val={stats.dp} /></p></div>
                                        <div className="text-center border-x border-gray-200"><p className="text-gray-400 font-black text-[9px] sm:text-[10px] uppercase tracking-tighter">æŒè‚¡å¸‚å€¼</p><p className="font-black text-base sm:text-xl text-gray-800 mt-0.5">{isMasked ? '****' : stats.mv.toLocaleString()}</p></div>
                                        <div className="text-center"><p className="text-gray-400 font-black text-[9px] sm:text-[10px] uppercase text-red-500">ç´¯ç©é…æ¯</p><p className="font-black text-base sm:text-xl text-gray-800 mt-0.5">{isMasked ? '****' : stats.td.toLocaleString()}</p></div>
                                    </div>
                                    <div className="flex px-4 sm:px-6 py-2 sm:py-3 text-[10px] sm:text-xs text-gray-400 font-black uppercase border-b border-gray-50 bg-white sticky top-0 z-10">
                                        <span className="w-[34%]">æ¨™çš„ / è‚¡æ•¸</span>
                                        <span className="w-[22%] text-right">ç¾åƒ¹</span>
                                        <span className="w-[22%] text-right">{showWithDividend ? 'å«æ¯' : 'å¹³å‡'}</span>
                                        <span className="w-[22%] text-right">æç›Š</span>
                                    </div>
                                    {Object.entries(stats.inv).map(([id, d]) => d.sh > 0 && (
                                        <div key={id} onClick={() => { setSelectedStockId(id); setView('detail'); }} className="flex px-4 sm:px-6 py-4 sm:py-5 border-b border-gray-50 items-center active:bg-gray-50 cursor-pointer transition-colors">
                                            <div className="w-[34%] pr-1 min-w-0">
                                                <p className="font-black text-sm sm:text-lg leading-tight truncate">{d.n}</p>
                                                <p className="text-[10px] sm:text-xs text-gray-400 truncate mt-0.5">{id} / {d.sh.toLocaleString()}è‚¡</p>
                                            </div>
                                            <div className="w-[22%] text-right min-w-0 pr-1">
                                                <p className="font-black text-sm sm:text-lg truncate">{marketData[id]?.p || "---"}</p>
                                                <p className={`text-[9px] sm:text-[10px] font-bold mt-0.5 truncate ${marketData[id]?.c >= 0 ? 'text-red-500' : 'text-green-600'}`}>{marketData[id]?.c >= 0 ? 'â–²' : 'â–¼'} {Math.abs(marketData[id]?.c || 0)}</p>
                                            </div>
                                            <div className="w-[22%] text-right font-bold text-gray-600 text-xs sm:text-base truncate pr-1">{isMasked ? '***' : ((d.cost - (showWithDividend?d.div:0))/d.sh).toFixed(2)}</div>
                                            <div className="w-[22%] text-right font-black text-sm sm:text-lg truncate pl-1"><Mask val={(d.sh*(marketData[id]?.p||0)) - d.cost + (showWithDividend?d.div:0)} /></div>
                                        </div>
                                    ))}
                                    {Object.keys(stats.inv).length === 0 && <div className="p-10 text-center text-gray-300 font-bold text-sm">é»æ“Šä¸‹æ–¹ + è™Ÿé–‹å§‹è¨˜éŒ„ç¬¬ä¸€ç­†äº¤æ˜“</div>}
                                </div>
                            </React.Fragment>
                        )}

                        {/* 2. äº¤æ˜“ç´€éŒ„ */}
                        {view === 'record' && (
                            <React.Fragment>
                                <div className="p-4 sm:p-6 flex justify-between items-center border-b border-gray-50 bg-white shrink-0">
                                    <h1 className="text-2xl sm:text-3xl font-black italic text-gray-800">æ­·å²äº¤æ˜“</h1>
                                    <button onClick={() => setRecordSortOrder(recordSortOrder === 'desc' ? 'asc' : 'desc')} className="p-2 bg-gray-50 rounded-xl active:scale-95 transition-transform"><Icon name="ArrowUpDown" className="w-5 h-5 sm:w-6 sm:h-6"/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto overflow-x-hidden pb-[140px] sm:pb-[160px]">
                                    {(() => {
                                        const groups = {};
                                        [...transactions].sort((a,b)=>recordSortOrder==='desc' ? b.timestamp-a.timestamp : a.timestamp-b.timestamp).forEach(tx => {
                                            if (!groups[tx.date]) groups[tx.date] = { txs: [], exp: 0 };
                                            groups[tx.date].txs.push(tx);
                                            if (tx.type === 'è²·é€²') groups[tx.date].exp += Math.abs(tx.total);
                                        });
                                        if (Object.keys(groups).length === 0) return <div className="p-20 text-center text-gray-300 font-black">å°šæœªæœ‰äº¤æ˜“ç´€éŒ„</div>;
                                        
                                        return Object.entries(groups).map(([date, g]) => (
                                            <div key={date}>
                                                <div className="bg-gray-50 px-4 sm:px-6 py-2 flex justify-between items-center border-b border-gray-100 font-black text-gray-400 text-[10px]"><span>{date}</span><span>ç•¶æ—¥æ”¯å‡º: {g.exp.toLocaleString()}</span></div>
                                                {g.txs.map(tx => (
                                                    <div key={tx.id} className="flex px-4 sm:px-6 py-4 sm:py-6 border-b border-gray-50 items-center hover:bg-gray-50 transition-colors">
                                                        <span className="w-[35%] font-black text-sm sm:text-lg truncate pr-1">{tx.stockName}</span>
                                                        <span className="w-[20%] text-center font-bold text-gray-500 text-[10px] sm:text-xs leading-tight truncate">{tx.type}<br/>{tx.shares.toLocaleString()}è‚¡</span>
                                                        <span className="w-[20%] text-right font-black text-sm sm:text-base truncate px-1">{tx.price.toLocaleString()}</span>
                                                        <div className="w-[25%] flex items-center justify-end space-x-1 sm:space-x-2 truncate">
                                                            <span className={`font-black text-sm sm:text-base ${tx.total >= 0 ? 'text-red-500' : 'text-green-600'}`}>{tx.total.toLocaleString()}</span>
                                                            <button onClick={()=>setPendingDeleteId(tx.id)} className="text-gray-300 p-1 hover:text-red-500 transition-colors"><Icon name="Trash" className="w-4 h-4 sm:w-5 sm:h-5"/></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ));
                                    })()}
                                </div>
                            </React.Fragment>
                        )}

                        {/* 3. è‚¡æ¯çµ±è¨ˆ */}
                        {view === 'dividend' && (
                            <React.Fragment>
                                <div className="p-4 sm:p-6 flex justify-between items-center border-b border-gray-50 bg-white shrink-0"><h1 className="text-2xl sm:text-3xl font-black italic text-gray-800 tracking-tighter">è‚¡æ¯çµ±è¨ˆ</h1><Icon name="Coins" className="w-6 h-6 sm:w-7 sm:h-7 text-blue-500"/></div>
                                <div className="flex-1 overflow-y-auto overflow-x-hidden pb-[140px] sm:pb-[160px] p-4 sm:p-6 space-y-6 sm:space-y-8">
                                    {(() => {
                                        const years = {};
                                        transactions.filter(t => t.type === 'é…æ¯').forEach(tx => {
                                            const year = tx.date.split('/')[0];
                                            if (!years[year]) years[year] = { stocks: {}, total: 0 };
                                            if (!years[year].stocks[tx.stockId]) years[year].stocks[tx.stockId] = { n: tx.stockName, amt: 0 };
                                            years[year].stocks[tx.stockId].amt += Math.abs(tx.total);
                                            years[year].total += Math.abs(tx.total);
                                        });
                                        const yearEntries = Object.entries(years).sort((a,b) => b[0] - a[0]);
                                        if (yearEntries.length === 0) return <div className="p-20 text-center text-gray-300 font-black">ç„¡é ˜æ¯ç´€éŒ„</div>;

                                        return yearEntries.map(([y, d]) => (
                                            <div key={y} className="bg-gray-50 rounded-2xl sm:rounded-[32px] overflow-hidden border border-gray-100 shadow-sm">
                                                <div className="bg-blue-600 px-4 sm:px-6 py-3 sm:py-4 flex justify-between items-center text-white"><span className="text-xl sm:text-2xl font-black">{y} å¹´åº¦</span><div className="text-right"><p className="text-[9px] sm:text-[10px] font-black opacity-60 uppercase">Yearly Total</p><p className="text-lg sm:text-xl font-black">${d.total.toLocaleString()}</p></div></div>
                                                <div className="p-4 space-y-3 sm:space-y-4">{Object.entries(d.stocks).map(([id, s]) => (<div key={id} className="flex justify-between items-center px-2 border-b border-gray-100 pb-3 sm:pb-4 last:border-0 last:pb-0"><div className="flex flex-col"><span className="font-black text-base sm:text-lg text-gray-800">{s.n}</span><span className="text-[9px] sm:text-[10px] font-black text-gray-400 mt-0.5">{id}</span></div><span className="text-lg sm:text-xl font-black text-red-500 tabular-nums">${s.amt.toLocaleString()}</span></div>))}</div>
                                            </div>
                                        ));
                                    })()}
                                </div>
                            </React.Fragment>
                        )}

                        {/* 4. è¨­å®šé é¢ */}
                        {view === 'settings' && (
                            <React.Fragment>
                                <div className="p-4 sm:p-6 flex items-center border-b border-gray-50 bg-white shrink-0"><button onClick={() => setView('holding')} className="p-1"><Icon name="ChevronLeft" className="w-8 h-8 sm:w-10 sm:h-10"/></button><h2 className="flex-1 text-center font-black text-xl sm:text-2xl tracking-tighter uppercase text-gray-800">ç³»çµ±è¨­å®š</h2><div className="w-10"></div></div>
                                <div className="p-6 sm:p-10 space-y-6 sm:space-y-8 flex-1 overflow-y-auto overflow-x-hidden">
                                    <div className="space-y-2 sm:space-y-3">
                                        <label className="flex items-center text-xs sm:text-sm font-black uppercase text-gray-400 tracking-widest"><Icon name="Key" className="w-4 h-4 sm:w-5 sm:h-5 mr-2"/> FinMind æŸ¥è©¢é‡‘é‘°</label>
                                        <input type="password" placeholder="è«‹è²¼ä¸Š FinMind API Token" className="w-full bg-gray-50 p-4 sm:p-6 rounded-xl sm:rounded-[24px] outline-none font-black text-base sm:text-lg border-2 border-transparent focus:border-blue-200 transition-all" value={apiToken} onChange={e => handleSaveToken(e.target.value)} />
                                    </div>
                                    
                                    <div className="h-px bg-gray-100 my-2"></div>
                                    
                                    <div className="space-y-2 sm:space-y-3">
                                        <label className="flex items-center text-xs sm:text-sm font-black uppercase text-gray-400 tracking-widest"><Icon name="Cloud" className="w-4 h-4 sm:w-5 sm:h-5 mr-2 text-blue-500"/> Firebase é›²ç«¯é‡‘é‘°</label>
                                        <p className="text-[10px] sm:text-xs text-gray-400 font-bold px-2 pb-1">å°‡ Firebase ç”¢ç”Ÿçš„ JSON ç¨‹å¼ç¢¼è²¼å…¥ï¼š</p>
                                        <textarea 
                                            placeholder='{&#10;  apiKey: "...",&#10;  projectId: "..."&#10;}' 
                                            className="w-full h-32 sm:h-40 bg-blue-50/50 p-4 rounded-xl sm:rounded-[24px] outline-none font-mono text-[10px] sm:text-xs border-2 border-transparent focus:border-blue-200 transition-all resize-none text-gray-600" 
                                            value={fbConfigInput} 
                                            onChange={e => setFbConfigInput(e.target.value)} 
                                        />
                                        <div className="flex space-x-2 sm:space-x-3 pt-2">
                                            <button onClick={handleSaveFbConfig} className="flex-1 py-3 sm:py-4 bg-blue-600 text-white rounded-xl sm:rounded-2xl font-black text-sm sm:text-base active:scale-95 transition-transform shadow-lg shadow-blue-200">å¥—ç”¨è¨­å®š</button>
                                            <button onClick={handleClearFbConfig} className="flex-1 py-3 sm:py-4 bg-gray-200 text-gray-600 rounded-xl sm:rounded-2xl font-black text-sm sm:text-base active:scale-95 transition-transform">åˆ‡å›å–®æ©Ÿ</button>
                                        </div>
                                    </div>

                                    <div className="h-px bg-gray-100 my-2"></div>

                                    <button onClick={() => { const b = new Blob([JSON.stringify(transactions)], {type: 'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'stockify_backup.json'; a.click(); }} className="w-full py-4 sm:py-6 bg-gray-900 text-white rounded-xl sm:rounded-[24px] font-black text-base sm:text-lg flex items-center justify-center space-x-2 sm:space-x-3 active:scale-95 shadow-xl transition-all"><Icon name="Download" className="w-6 h-6 sm:w-7 sm:h-7"/><span>åŒ¯å‡ºç´€éŒ„å‚™ä»½ (.json)</span></button>
                                    
                                    {!isFirebaseConfigured && (
                                        <label className="w-full py-4 sm:py-6 border-2 border-gray-200 text-gray-500 rounded-xl sm:rounded-[24px] font-black text-base sm:text-lg flex items-center justify-center space-x-2 sm:space-x-3 cursor-pointer active:bg-gray-50 transition-colors">
                                            <Icon name="Upload" className="w-6 h-6 sm:w-7 sm:h-7"/><span>åŒ¯å…¥ç´€éŒ„æª”</span>
                                            <input type="file" className="hidden" accept=".json" onChange={handleImport} />
                                        </label>
                                    )}
                                </div>
                            </React.Fragment>
                        )}

                        {/* 5. å€‹è‚¡è©³æƒ… */}
                        {view === 'detail' && selectedStockId && (
                            <React.Fragment>
                                <div className="p-4 sm:p-5 flex items-center border-b border-gray-50 bg-white shrink-0"><button onClick={() => setView('holding')} className="p-1"><Icon name="ChevronLeft" className="w-8 h-8 sm:w-10 sm:h-10"/></button><h2 className="flex-1 text-center font-black text-xl sm:text-2xl tracking-tight uppercase tracking-tighter">{selectedStockId} {stockMaster[selectedStockId]?.n}</h2><button onClick={() => { setFormCode(selectedStockId); setView('add'); }} className="p-1 text-blue-500 active:scale-90 transition-transform"><Icon name="Plus" className="w-8 h-8 sm:w-10 sm:h-10"/></button></div>
                                {(() => {
                                    const d = stats.inv[selectedStockId];
                                    if (!d) return null;
                                    const m = marketData[selectedStockId] || { p: 0, c: 0 };
                                    const unrealized = (d.sh * m.p) - d.cost, profitToShow = showWithDividend ? unrealized + d.div : unrealized;
                                    const avg = d.sh > 0 ? (d.cost / d.sh) : 0, divP = d.sh > 0 ? (d.div / d.sh) : 0, displayA = showWithDividend ? (avg - divP).toFixed(2) : avg.toFixed(2);
                                    return (
                                        <div className="flex-1 flex flex-col overflow-y-auto overflow-x-hidden">
                                            <div className={`px-4 sm:px-6 py-4 sm:py-5 flex justify-between items-center shrink-0 ${m.c >= 0 ? 'bg-red-50' : 'bg-green-50'}`}><div className={`font-black text-2xl sm:text-3xl ${m.c >= 0 ? 'text-red-500' : 'text-green-600'}`}>{m.p} <span className="text-sm sm:text-base font-bold ml-1">{m.c >= 0 ? 'â–²' : 'â–¼'} {Math.abs(m.c)}</span></div><button onClick={()=>setShowWithDividend(!showWithDividend)} className="px-2 py-1 sm:px-3 sm:py-1.5 rounded-lg sm:rounded-full bg-white border border-gray-200 text-[10px] sm:text-xs font-black shadow-sm flex items-center space-x-1 transition-all active:scale-95">{showWithDividend ? <Icon name="ToggleRight" className="w-4 h-4 sm:w-5 sm:h-5 text-blue-500"/> : <Icon name="ToggleLeft" className="w-4 h-4 sm:w-5 sm:h-5 text-gray-300"/>} <span>{showWithDividend ? 'å«æ¯' : 'é™¤æ¯'}</span></button></div>
                                            <div className="p-6 sm:p-8 border-b border-gray-50 shrink-0"><p className="text-gray-400 text-xs sm:text-sm font-black uppercase mb-1 leading-none">{showWithDividend ? 'ç´¯ç©æç›Š (å«æ¯)' : 'æŒè‚¡æœªå¯¦ç¾æç›Š'}</p><h3 className={`text-4xl sm:text-5xl font-black tabular-nums tracking-tighter`}><Mask val={profitToShow} /></h3>
                                                <div className="grid grid-cols-3 gap-y-6 sm:gap-y-12 mt-8 sm:mt-12 text-center text-[11px] sm:text-[13px]">
                                                    <div className="text-left leading-tight"><p className="text-gray-400 font-black uppercase tracking-tight">{showWithDividend ? 'å«æ¯æˆæœ¬' : 'å¹³å‡æˆæœ¬'}</p><p className="font-black text-lg sm:text-2xl text-gray-800 mt-0.5">{isMasked ? '***' : displayA}</p></div>
                                                    <div><p className="text-gray-400 font-black uppercase text-blue-600">å·²å¯¦ç¾æç›Š</p><p className={`font-black text-lg sm:text-2xl mt-0.5`}><Mask val={d.realized} /></p></div>
                                                    <div className="text-right"><p className="text-gray-400 font-black uppercase">æŒè‚¡æ•¸</p><p className="font-black text-lg sm:text-2xl text-gray-800 mt-0.5">{d.sh.toLocaleString()}</p></div>
                                                    <div className="text-left leading-tight"><p className="text-gray-400 font-black uppercase">ä»Šæ—¥ç›ˆè™§</p><p className="font-black text-lg sm:text-2xl mt-0.5"><Mask val={d.sh * m.c} /></p></div>
                                                    <div><p className="text-gray-400 font-black uppercase">æŒè‚¡å¸‚å€¼</p><p className="font-black text-lg sm:text-2xl text-gray-800 mt-0.5">{(d.sh * m.p).toLocaleString()}</p></div>
                                                    <div className="text-right"><p className="text-gray-400 font-black uppercase text-red-500">ç´¯ç©é…æ¯</p><p className="font-black text-lg sm:text-2xl text-gray-800 mt-0.5">{d.div.toLocaleString()}</p></div>
                                                </div>
                                            </div>
                                            <div className="flex-1 bg-gray-50/40 pb-10">
                                                <div className="flex px-4 sm:px-6 py-2 sm:py-3 text-[10px] sm:text-xs text-gray-400 font-black uppercase border-b border-gray-100 bg-white sticky top-0 z-10">
                                                    <span className="w-[30%] sm:w-[35%]">æ—¥æœŸ</span><span className="w-[20%] text-center">äº¤æ˜“</span><span className="w-[20%] text-right">åƒ¹æ ¼</span><span className="w-[30%] sm:w-[25%] text-right">æ”¶æ”¯</span>
                                                </div>
                                                {d.history.sort((a,b)=>b.timestamp-a.timestamp).map(tx => (
                                                    <div key={tx.id} className="flex px-4 sm:px-6 py-4 sm:py-6 border-b border-gray-50 items-center hover:bg-white transition-colors">
                                                        <span className="w-[30%] sm:w-[35%] font-black text-gray-400 text-xs sm:text-sm pr-1 truncate">{tx.date.substring(5)}</span>
                                                        <span className="w-[20%] text-center font-black text-gray-800 text-[10px] sm:text-xs leading-tight truncate">{tx.type}<br/>{tx.shares > 0 ? `${tx.shares.toLocaleString()}è‚¡` : ''}</span>
                                                        <span className="w-[20%] text-right font-black text-sm sm:text-base px-1 truncate">{tx.price > 0 ? tx.price.toLocaleString() : '-'}</span>
                                                        <div className="w-[30%] sm:w-[25%] flex items-center justify-end space-x-1 sm:space-x-3 truncate">
                                                            <Mask val={tx.total} />
                                                            <button onClick={() => setPendingDeleteId(tx.id)} className="text-gray-300 hover:text-red-400 transition-colors p-1"><Icon name="Trash" className="w-4 h-4 sm:w-5 sm:h-5"/></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )
                                })()}
                            </React.Fragment>
                        )}
                        
                        {/* 6. æ–°å¢ç´€éŒ„ (å¾¹åº•é‡æ§‹ç‚º Flexboxï¼Œæ‹’çµ•çµ•å°å®šä½) */}
                        {view === 'add' && (
                            <div className="flex flex-col h-full w-full bg-white z-[100] animate-in slide-in-from-bottom-4">
                                {/* Header */}
                                <div className="p-4 sm:p-5 flex items-center border-b border-gray-50 bg-white shrink-0">
                                    <button onClick={() => setView('holding')} className="p-1 active:scale-90"><Icon name="ChevronLeft" className="w-8 h-8 sm:w-10 sm:h-10"/></button>
                                    <h2 className="flex-1 text-center font-black text-xl sm:text-2xl uppercase tracking-tighter">æ–°å¢ç´€éŒ„</h2>
                                    <div className="w-8 sm:w-10"></div>
                                </div>
                                
                                {/* æ²å‹•å…§å®¹å€ (ä¿®æ­£æ©«å‘æ²å‹•èˆ‡é«˜åº¦å•é¡Œ) */}
                                <div className="flex-1 overflow-y-auto overflow-x-hidden p-6 sm:p-10 bg-white">
                                    <div className="max-w-md mx-auto space-y-6 sm:space-y-8 pb-10">
                                        
                                        {/* æˆåŠŸæç¤º Toast */}
                                        {toastMsg && (
                                            <div className="mb-4 p-4 bg-green-50 border border-green-100 text-green-700 rounded-2xl flex items-center justify-center font-bold text-sm animate-in fade-in zoom-in slide-in-from-top-4 shadow-sm">
                                                <Icon name="CheckCircle2" className="w-6 h-6 mr-2 text-green-600" />
                                                {toastMsg}
                                            </div>
                                        )}

                                        <div className="space-y-2">
                                            <div className="flex items-center space-x-3 sm:space-x-6">
                                                <label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0 leading-tight">è‚¡ç¥¨ä»£è™Ÿ</label>
                                                <input className="flex-1 min-w-0 bg-gray-50 p-4 sm:p-5 rounded-xl sm:rounded-[24px] outline-none font-black text-xl sm:text-2xl uppercase" placeholder="å¦‚ 2330" value={formCode} onChange={e=>setFormCode(e.target.value)} />
                                            </div>
                                            <div className="pl-[76px] sm:pl-[104px] font-black text-blue-600 text-sm sm:text-lg min-h-[24px]">
                                                {isSearchingName ? "æœå°‹ä¸­..." : (stockMaster[formCode.toUpperCase()]?.n || "è¼¸å…¥ä»£è™Ÿç¢ºèª")}
                                            </div>
                                        </div>

                                        <div className="flex items-center space-x-3 sm:space-x-6">
                                            <label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0 leading-tight">æˆäº¤æ—¥æœŸ</label>
                                            <div className="flex-1 relative min-w-0">
                                                <input type="date" className="w-full bg-gray-50 p-4 sm:p-5 rounded-xl sm:rounded-[24px] outline-none font-black text-base sm:text-xl" value={formDate} onChange={e=>setFormDate(e.target.value)} />
                                                <Icon name="Calendar" className="absolute right-4 sm:right-6 top-1/2 -translate-y-1/2 text-gray-300 pointer-events-none w-5 h-5 sm:w-6 sm:h-6"/>
                                            </div>
                                        </div>

                                        <div className="flex items-center space-x-3 sm:space-x-6">
                                            <label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0 leading-tight">äº¤æ˜“å‹•ä½œ</label>
                                            <div className="flex flex-1 space-x-2 min-w-0">
                                                {['è²·é€²','è³£å‡º','é…æ¯'].map(t=>(<button key={t} onClick={()=>{setActiveTab(t); setFormFee(''); setFormTotalAmount('');}} className={`flex-1 py-3 sm:py-4 rounded-xl text-sm sm:text-lg font-black transition-all px-0 ${activeTab===t?'bg-blue-600 text-white shadow-md':'bg-gray-100 text-gray-400'}`}>{t}</button>))}
                                            </div>
                                        </div>

                                        <div className="space-y-6 sm:space-y-8 pt-4">
                                            {activeTab === 'é…æ¯' ? (
                                                <React.Fragment>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0">é…ç™¼é‡‘é¡</label><input type="number" value={formTotalAmount} onChange={e=>setFormTotalAmount(e.target.value)} className="flex-1 min-w-0 ml-3 outline-none font-black text-2xl sm:text-3xl text-blue-600 bg-transparent" placeholder="0" /></div>
                                                    <div className="text-center text-gray-200 font-bold text-[9px] sm:text-xs uppercase tracking-[3px] py-2">æˆ–ä½¿ç”¨æ˜ç´°è¨ˆç®—</div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0">æ¯è‚¡è‚¡æ¯</label><input type="number" value={formPrice} onChange={e=>setFormPrice(e.target.value)} className="flex-1 min-w-0 ml-3 outline-none font-black text-2xl sm:text-3xl bg-transparent" placeholder="0.00" /></div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0">é™¤æ¯è‚¡æ•¸</label><input type="number" value={formShares} onChange={e=>setFormShares(e.target.value)} className="flex-1 min-w-0 ml-3 outline-none font-black text-2xl sm:text-3xl bg-transparent" placeholder="0" /></div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0">åŒ¯è²»æ‰£é™¤</label><input type="number" value={formFee} onChange={e=>setFormFee(e.target.value)} className="flex-1 min-w-0 ml-3 outline-none font-black text-2xl sm:text-3xl bg-transparent text-gray-400" placeholder="10" /></div>
                                                </React.Fragment>
                                            ) : (
                                                <React.Fragment>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0">æˆäº¤åƒ¹æ ¼</label><input type="number" value={formPrice} onChange={e=>setFormPrice(e.target.value)} className="flex-1 min-w-0 ml-3 outline-none font-black text-2xl sm:text-3xl bg-transparent" placeholder="0.00" /></div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0">æˆäº¤è‚¡æ•¸</label><input type="number" value={formShares} onChange={e=>setFormShares(e.target.value)} className="flex-1 min-w-0 ml-3 outline-none font-black text-2xl sm:text-3xl bg-transparent" placeholder="0" /></div>
                                                    <div className="flex items-center border-b border-gray-100 pb-4"><label className="text-gray-400 font-black text-[11px] sm:text-sm uppercase w-16 sm:w-20 shrink-0">æ‰‹çºŒè²»/ç¨…</label><input type="number" value={formFee} onChange={e=>setFormFee(e.target.value)} className="flex-1 min-w-0 ml-3 outline-none font-black text-2xl sm:text-3xl bg-transparent text-gray-500" placeholder={calc.autoFee > 0 ? calc.autoFee.toString() : "è‡ªå‹•é ä¼°"} /></div>
                                                </React.Fragment>
                                            )}
                                        </div>

                                        <div className="bg-blue-50/50 p-6 sm:p-8 rounded-2xl sm:rounded-[32px] border border-blue-100/50 mt-8">
                                            <div className="flex justify-between font-black text-blue-900 items-baseline">
                                                <span className="text-sm sm:text-base shrink-0">{activeTab==='è²·é€²'?'ç¸½æ”¯å‡º':activeTab==='è³£å‡º'?'ç¸½æ”¶å…¥':'æœ€çµ‚å…¥å¸³'}</span>
                                                <span className="text-3xl sm:text-4xl tabular-nums tracking-tighter truncate pl-4">$ {Math.abs(calc.total).toLocaleString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* åº•éƒ¨å›ºå®šæŒ‰éˆ•å€ (é‡˜æ­»åœ¨ Flex å®¹å™¨åº•éƒ¨) */}
                                <div className="shrink-0 p-4 sm:p-6 grid grid-cols-2 gap-3 sm:gap-4 border-t border-gray-100 bg-white safe-pb shadow-[0_-10px_20px_rgba(0,0,0,0.03)]">
                                    <button onClick={()=>saveTx(true)} disabled={isSaving} className="py-4 sm:py-5 border-2 border-blue-600 text-blue-600 rounded-xl sm:rounded-2xl font-black text-base sm:text-lg active:scale-95 transition-all flex justify-center items-center h-[56px] sm:h-[64px]">
                                        {isSaving ? <Icon name="Loader2" className="animate-spin w-6 h-6"/> : 'å†è¨˜ä¸€ç­†'}
                                    </button>
                                    <button onClick={()=>saveTx(false)} disabled={isSaving} className="py-4 sm:py-5 bg-blue-600 text-white rounded-xl sm:rounded-2xl font-black text-base sm:text-lg shadow-lg shadow-blue-100 active:scale-95 transition-all flex justify-center items-center h-[56px] sm:h-[64px]">
                                        {isSaving ? <Icon name="Loader2" className="animate-spin w-6 h-6"/> : 'å®Œæˆå­˜æª”'}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* === å…±ç”¨æµ®å‹•å°è¦½å³¶ (åƒ…åœ¨ä¸»ç•«é¢é¡¯ç¤º) === */}
                    {(view === 'holding' || view === 'record' || view === 'dividend') && (
                        <React.Fragment>
                            <div className="absolute left-4 sm:left-6 right-4 sm:right-6 h-16 sm:h-20 bg-white/90 backdrop-blur-2xl border border-white/50 rounded-2xl sm:rounded-[32px] flex items-center justify-between px-2 sm:px-6 z-50 shadow-[0_20px_50px_rgba(0,0,0,0.1)] nav-island">
                                <div className="flex flex-1 justify-around items-center pr-6 sm:pr-10">
                                    <button onClick={() => setView('holding')} className={`flex flex-col items-center ${view==='holding'?'text-blue-600':'text-gray-300'} active:scale-95 transition-transform`}><Icon name="PieChart" className="w-6 h-6 sm:w-7 sm:h-7"/><span className="text-[9px] sm:text-[10px] font-black mt-1 uppercase">æŒè‚¡</span></button>
                                    <button onClick={() => setView('record')} className={`flex flex-col items-center ${view==='record'?'text-blue-600':'text-gray-300'} active:scale-95 transition-transform`}><Icon name="History" className="w-6 h-6 sm:w-7 sm:h-7"/><span className="text-[9px] sm:text-[10px] font-black mt-1 uppercase">ç´€éŒ„</span></button>
                                </div>
                                <div className="flex flex-1 justify-around items-center pl-6 sm:pl-10">
                                    <button onClick={() => setView('dividend')} className={`flex flex-col items-center ${view==='dividend'?'text-blue-600':'text-gray-300'} active:scale-95 transition-transform`}><Icon name="Coins" className="w-6 h-6 sm:w-7 sm:h-7"/><span className="text-[9px] sm:text-[10px] font-black mt-1 uppercase">è‚¡æ¯</span></button>
                                    <button onClick={syncMarketData} className={`flex flex-col items-center ${isUpdating?'animate-spin text-blue-400':'text-gray-300'} active:scale-95 transition-transform`}><Icon name="Refresh" className="w-6 h-6 sm:w-7 sm:h-7"/><span className="text-[9px] sm:text-[10px] font-black mt-1 uppercase">åŒæ­¥</span></button>
                                </div>
                            </div>
                            <button onClick={() => { setFormCode(''); setView('add'); }} className="absolute left-1/2 -translate-x-1/2 w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white z-[60] shadow-xl border-[4px] sm:border-[6px] border-white active:scale-90 transition-all fab-btn">
                                <Icon name="Plus" className="w-8 h-8 sm:w-10 sm:h-10"/>
                            </button>
                        </React.Fragment>
                    )}

                    {/* åˆªé™¤ç¢ºèªå½ˆçª— */}
                    {pendingDeleteId && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-xs rounded-2xl sm:rounded-[32px] p-6 sm:p-8 shadow-2xl animate-in zoom-in-95">
                                <div className="bg-red-50 w-14 h-14 sm:w-16 sm:h-16 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6 text-red-500"><Icon name="AlertCircle" className="w-6 h-6 sm:w-8 sm:h-8" /></div>
                                <h3 className="text-xl sm:text-2xl font-black text-center mb-2 text-gray-800 tracking-tighter">ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ</h3>
                                <p className="text-gray-500 text-center mb-6 sm:mb-8 font-bold text-xs sm:text-sm">åˆªé™¤å¾Œè³‡æ–™å°‡ç„¡æ³•é‚„åŸï¼Œä¸”æœƒé‡æ–°è¨ˆç®—è³‡ç”¢æ•¸æ“šã€‚</p>
                                <div className="grid grid-cols-2 gap-3 sm:gap-4">
                                    <button onClick={()=>setPendingDeleteId(null)} className="py-3 sm:py-4 bg-gray-100 rounded-xl sm:rounded-2xl font-black text-gray-500 text-sm sm:text-base active:scale-95 transition-transform">å–æ¶ˆ</button>
                                    <button onClick={confirmDelete} className="py-3 sm:py-4 bg-red-500 rounded-xl sm:rounded-2xl font-black text-white text-sm sm:text-base shadow-md active:scale-95 transition-transform">ç¢ºèªåˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
